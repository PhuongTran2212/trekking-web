{% extends 'base.html' %}
{% load static %}

{% block title %}Ch·ªânh s·ª≠a b√†i vi·∫øt - {{ bai_viet.tieu_de|truncatechars:30 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/community.css' %}">
<style>
  /* Container cho m·ªói media item c·∫ßn c√≥ position: relative
     ƒë·ªÉ n√∫t x√≥a (v·ªõi position: absolute) c√≥ th·ªÉ ƒë·ªãnh v·ªã theo n√≥ */
  .media-item {
    position: relative;
    display: inline-block;
    margin: 5px;
    vertical-align: top;
    width: 250px; /* C√≥ th·ªÉ ƒë·∫∑t chi·ªÅu r·ªông c·ªë ƒë·ªãnh ƒë·ªÉ ƒë·ªìng ƒë·ªÅu */
    height: 250px;
    overflow: hidden;
    background-color: #f0f2f5;
    border-radius: 8px;
  }
  .media-item img, .media-item video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh/video l·∫•p ƒë·∫ßy m√† kh√¥ng b·ªã m√©o */
  }

  /* Style cho n√∫t x√≥a ·ªü g√≥c, √°p d·ª•ng cho c·∫£ media c≈© v√† m·ªõi */
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    z-index: 10;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    width: 28px;
    height: 28px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    font-weight: bold;
    color: #606770;
    font-size: 18px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: background-color 0.2s;
  }

  .delete-btn:hover {
    background-color: #E4E6E9;
  }
  
  .post-media-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">‚úèÔ∏è Ch·ªânh s·ª≠a b√†i vi·∫øt</h4>
        </div>
        <div class="card-body p-4">
          <form method="post" enctype="multipart/form-data" id="edit-post-form">
            {% csrf_token %}

            <!-- Ti√™u ƒë·ªÅ -->
            <div class="mb-3">
              <label for="{{ form.tieu_de.id_for_label }}" class="form-label fw-bold">{{ form.tieu_de.label }}</label>
              {{ form.tieu_de }}
              {% if form.tieu_de.errors %}
                <div class="text-danger small mt-1">{{ form.tieu_de.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- N·ªôi dung -->
            <div class="mb-3">
              <label for="{{ form.noi_dung.id_for_label }}" class="form-label fw-bold">{{ form.noi_dung.label }}</label>
              {{ form.noi_dung }}
              {% if form.noi_dung.errors %}
                <div class="text-danger small mt-1">{{ form.noi_dung.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- Chuy·∫øn ƒëi -->
            <div class="mb-3">
              <label for="{{ form.chuyen_di.id_for_label }}" class="form-label fw-bold">{{ form.chuyen_di.label }}</label>
              {{ form.chuyen_di }}
            </div>

            <!-- Tags -->
            <div class="mb-4">
              <label class="form-label fw-bold">{{ form.tags.label }}</label>
              <div class="tag-checkbox-container border rounded p-3 bg-light">{{ form.tags }}</div>
            </div>

            <!-- Media hi·ªán t·∫°i -->
            {% if bai_viet.media.all %}
            <div class="mb-4">
              <label class="form-label fw-bold">Media hi·ªán t·∫°i</label>
              <div class="post-media-gallery" id="existing-media">
                {% for media in bai_viet.media.all %}
                <div class="media-item" id="media-container-{{ media.id }}">
                  {% if media.loai_media == 'anh' %}
                    <img src="{{ media.duong_dan_file.url }}" alt="Media b√†i vi·∫øt">
                  {% else %}
                    <video src="{{ media.duong_dan_file.url }}"></video>
                  {% endif %}
                  <button
                    type="button"
                    class="delete-btn existing-media-delete-btn"
                    title="X√≥a media n√†y"
                    data-media-id="{{ media.id }}"
                    data-delete-url="{% url 'community:xoa-media' media.id %}"
                  >&times;</button>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Xem tr∆∞·ªõc media m·ªõi -->
            <div class="mb-4">
              <label class="form-label fw-bold text-success">Media m·ªõi s·∫Ω ƒë∆∞·ª£c th√™m (xem tr∆∞·ªõc):</label>
              <div id="preview-container" class="post-media-gallery">
                 <!-- Preview s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
              </div>
            </div>

            <!-- Th√™m media m·ªõi -->
            <div class="mb-4">
              <label for="media_files" class="form-label fw-bold">Th√™m ·∫£nh/video m·ªõi (t√πy ch·ªçn)</label>
              <input
                type="file"
                class="form-control"
                id="media_files"
                name="media_files"
                multiple
                accept="image/*,video/*"
              />
            </div>

            <div class="alert alert-info">
              <strong>L∆∞u √Ω:</strong> Sau khi ch·ªânh s·ª≠a, b√†i vi·∫øt s·∫Ω tr·ªü l·∫°i tr·∫°ng th√°i <em>‚ÄúCh·ªù duy·ªát‚Äù</em> ƒë·ªÉ qu·∫£n tr·ªã vi√™n xem l·∫°i.
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
              <a href="{% url 'community:bai-viet-cua-toi' %}" class="btn btn-secondary">H·ªßy</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script x·ª≠ l√Ω x√≥a + xem tr∆∞·ªõc -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  // ===============================
  // üóëÔ∏è X·ª≠ l√Ω x√≥a media HI·ªÜN T·∫†I (tr√™n server)
  // ===============================
  document.querySelectorAll(".existing-media-delete-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a media n√†y kh√¥ng? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) return;

      const mediaId = this.dataset.mediaId;
      const deleteUrl = this.dataset.deleteUrl;
      const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

      fetch(deleteUrl, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
      })
      .then(response => {
        if (!response.ok) {
            throw new Error('Server responded with an error!');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          const mediaContainer = document.getElementById(`media-container-${mediaId}`);
          if (mediaContainer) {
              mediaContainer.remove();
          }
        } else {
          alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ x√≥a media.'));
        }
      })
      .catch(error => {
        console.error('Fetch Error:', error);
        alert('ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
      });
    });
  });

  // ===========================================
  // üåÑ X·ª≠ l√Ω xem tr∆∞·ªõc v√† x√≥a media M·ªöI ƒë∆∞·ª£c ch·ªçn
  // ===========================================
  const fileInput = document.getElementById("media_files");
  const previewContainer = document.getElementById("preview-container");
  
  // M·∫£ng n√†y s·∫Ω l∆∞u c√°c file ng∆∞·ªùi d√πng ch·ªçn
  let selectedFiles = [];

  fileInput.addEventListener("change", function(event) {
    // Th√™m c√°c file m·ªõi v√†o m·∫£ng
    Array.from(event.target.files).forEach(file => {
        selectedFiles.push(file);
    });
    updatePreview();
    updateFileInput();
  });

  function updatePreview() {
    previewContainer.innerHTML = ""; // X√≥a c√°c preview c≈© ƒë·ªÉ v·∫Ω l·∫°i

    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        
        const mediaWrapper = document.createElement("div");
        mediaWrapper.classList.add("media-item");

        reader.onload = function(e) {
            const url = e.target.result;
            let mediaElement;

            if (file.type.startsWith("image/")) {
                mediaElement = document.createElement("img");
                mediaElement.src = url;
            } else if (file.type.startsWith("video/")) {
                mediaElement = document.createElement("video");
                mediaElement.src = url;
                // C√≥ th·ªÉ th√™m 'controls' n·∫øu mu·ªën xem video ngay tr√™n preview
                // mediaElement.controls = true; 
            }
            if (mediaElement) mediaWrapper.appendChild(mediaElement);
        }

        reader.readAsDataURL(file);

        // T·∫°o n√∫t x√≥a cho t·ª´ng preview
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "&times;";
        deleteBtn.type = "button";
        deleteBtn.classList.add("delete-btn");
        deleteBtn.title = `X√≥a ${file.name}`;
        
        deleteBtn.addEventListener("click", function() {
            // X√≥a file kh·ªèi m·∫£ng v√† c·∫≠p nh·∫≠t l·∫°i
            selectedFiles.splice(index, 1);
            updatePreview();
            updateFileInput();
        });

        mediaWrapper.appendChild(deleteBtn);
        previewContainer.appendChild(mediaWrapper);
    });
  }

  // C·∫≠p nh·∫≠t l·∫°i danh s√°ch file trong input tr∆∞·ªõc khi submit form
  function updateFileInput() {
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => {
          dataTransfer.items.add(file);
      });
      fileInput.files = dataTransfer.files;
  }
});
</script>
{% endblock %}