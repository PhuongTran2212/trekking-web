{% extends 'base.html' %}
{% load static %}

{% block title %} T·∫°o b√†i vi·∫øt m·ªõi {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/community.css' %}">
<style>
  /* === B·∫ÆT ƒê·∫¶U: CSS CHO MEDIA PREVIEW (SAO CH√âP T·ª™ TRANG S·ª¨A B√ÄI VI·∫æT) === */
  .tag-checkbox-container ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
    columns: 2;
    -webkit-columns: 2;
    -moz-columns: 2;
  }
  .tag-checkbox-container li {
    padding: 0.25rem 0;
    break-inside: avoid-column;
  }
  .tag-checkbox-container label {
    margin-left: 0.5rem;
    font-weight: normal;
    cursor: pointer;
  }

  /* Hi·ªÉn th·ªã media trong grid layout */
  .post-media-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c item */
  }

  /* Container cho m·ªói media item (·∫£nh/video) */
  .media-item {
    position: relative;
    display: inline-block;
    width: 250px;
    height: 250px;
    overflow: hidden;
    background-color: #f0f2f5;
    border-radius: 8px; /* Bo g√≥c m·ªÅm m·∫°i */
  }
  .media-item img, .media-item video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ƒê·∫£m b·∫£o media l·∫•p ƒë·∫ßy khung m√† kh√¥ng b·ªã m√©o */
  }

  /* N√∫t x√≥a 'x' ·ªü g√≥c tr√™n b√™n ph·∫£i */
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    z-index: 10;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    width: 28px;
    height: 28px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    font-weight: bold;
    color: #606770;
    font-size: 18px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: background-color 0.2s;
  }
  .delete-btn:hover {
    background-color: #E4E6E9;
  }
  /* === K·∫æT TH√öC: CSS CHO MEDIA PREVIEW === */
</style>
{% endblock %}


{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">‚úçÔ∏è T·∫°o b√†i vi·∫øt m·ªõi</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {# Ti√™u ƒë·ªÅ #}
            <div class="mb-3">
              <label for="{{ form.tieu_de.id_for_label }}" class="form-label">
                {{ form.tieu_de.label }}
              </label>
              {{ form.tieu_de }}
              {% if form.tieu_de.errors %}
                <div class="text-danger small mt-1">{{ form.tieu_de.errors|striptags }}</div>
              {% endif %}
            </div>

            {# N·ªôi dung #}
            <div class="mb-3">
              <label for="{{ form.noi_dung.id_for_label }}" class="form-label">
                {{ form.noi_dung.label }}
              </label>
              {{ form.noi_dung }}
              {% if form.noi_dung.errors %}
                <div class="text-danger small mt-1">{{ form.noi_dung.errors|striptags }}</div>
              {% endif %}
            </div>

            {# Chuy·∫øn ƒëi #}
            <div class="mb-3">
              <label for="{{ form.chuyen_di.id_for_label }}" class="form-label">
                {{ form.chuyen_di.label }}
              </label>
              {{ form.chuyen_di }}
              {% if form.chuyen_di.errors %}
                <div class="text-danger small mt-1">{{ form.chuyen_di.errors|striptags }}</div>
              {% endif %}
            </div>
            
            {# Tags #}
            <div class="mb-3">
              <label class="form-label">{{ form.tags.label }}</label>
              <div class="tag-checkbox-container p-3 border rounded">
                {{ form.tags }}
              </div>
              {% if form.tags.errors %}
                <div class="text-danger small mt-1">{{ form.tags.errors|striptags }}</div>
              {% endif %}
            </div>

            {# Upload media #}
            <div class="mb-3">
              <label for="media_files" class="form-label">
                üì∑ T·∫£i l√™n ·∫£nh/video (t√πy ch·ªçn)
              </label>
              <input
                type="file"
                class="form-control"
                id="media_files"
                name="media_files"
                multiple
                accept="image/*,video/*"
              />
              <small class="text-muted">
                B·∫°n c√≥ th·ªÉ ch·ªçn v√† x√≥a t·ª´ng file tr∆∞·ªõc khi ƒëƒÉng.
              </small>
            </div>

            {# === B·∫ÆT ƒê·∫¶U: KHU V·ª∞C XEM TR∆Ø·ªöC MEDIA ƒê√É C·∫¨P NH·∫¨T === #}
            <div id="preview-container" class="post-media-gallery mb-3">
              <!-- Xem tr∆∞·ªõc media s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
            {# === K·∫æT TH√öC: KHU V·ª∞C XEM TR∆Ø·ªöC MEDIA ƒê√É C·∫¨P NH·∫¨T === #}

            <div class="alert alert-info mt-3">
              <strong>üìå L∆∞u √Ω:</strong> B√†i vi·∫øt c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn qu·∫£n
              tr·ªã vi√™n ƒë·ªÉ duy·ªát. Sau khi ƒë∆∞·ª£c ph√™ duy·ªát, b√†i vi·∫øt s·∫Ω hi·ªÉn th·ªã
              trong c·ªông ƒë·ªìng.
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">üì§ ƒêƒÉng b√†i</button>
              <a
                href="{% url 'community:danh-sach-bai-viet' %}"
                class="btn btn-secondary"
                >H·ªßy</a
              >
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{# === B·∫ÆT ƒê·∫¶U: SCRIPT M·ªöI ƒê·ªÇ XEM TR∆Ø·ªöC V√Ä X√ìA MEDIA === #}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const fileInput = document.getElementById("media_files");
  const previewContainer = document.getElementById("preview-container");
  
  // M·∫£ng n√†y s·∫Ω l∆∞u c√°c file ng∆∞·ªùi d√πng ch·ªçn ƒë·ªÉ d·ªÖ d√†ng qu·∫£n l√Ω (th√™m/x√≥a)
  let selectedFiles = [];

  fileInput.addEventListener("change", function(event) {
    // Th√™m c√°c file m·ªõi ƒë∆∞·ª£c ch·ªçn v√†o m·∫£ng
    Array.from(event.target.files).forEach(file => {
        selectedFiles.push(file);
    });
    // C·∫≠p nh·∫≠t l·∫°i giao di·ªán xem tr∆∞·ªõc v√† danh s√°ch file trong input
    updatePreview();
    updateFileInput();
  });

  function updatePreview() {
    previewContainer.innerHTML = ""; // X√≥a c√°c preview c≈© ƒë·ªÉ v·∫Ω l·∫°i t·ª´ ƒë·∫ßu

    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        
        const mediaWrapper = document.createElement("div");
        mediaWrapper.classList.add("media-item");

        reader.onload = function(e) {
            const url = e.target.result;
            let mediaElement;

            if (file.type.startsWith("image/")) {
                mediaElement = document.createElement("img");
                mediaElement.src = url;
                mediaElement.alt = file.name;
            } else if (file.type.startsWith("video/")) {
                mediaElement = document.createElement("video");
                mediaElement.src = url;
                // Th√™m thu·ªôc t√≠nh ƒë·ªÉ video kh√¥ng t·ª± ƒë·ªông ph√°t v√† t·∫Øt ti·∫øng
                mediaElement.muted = true;
                mediaElement.playsInline = true;
            }
            if (mediaElement) mediaWrapper.appendChild(mediaElement);
        }

        reader.readAsDataURL(file);

        // T·∫°o n√∫t x√≥a 'x' cho t·ª´ng media
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "&times;";
        deleteBtn.type = "button";
        deleteBtn.classList.add("delete-btn");
        deleteBtn.title = `X√≥a ${file.name}`;
        
        // G√°n s·ª± ki·ªán click ƒë·ªÉ x√≥a file
        deleteBtn.addEventListener("click", function() {
            // X√≥a file kh·ªèi m·∫£ng t·∫°i v·ªã tr√≠ 'index'
            selectedFiles.splice(index, 1);
            // C·∫≠p nh·∫≠t l·∫°i giao di·ªán v√† input
            updatePreview();
            updateFileInput();
        });

        mediaWrapper.appendChild(deleteBtn);
        previewContainer.appendChild(mediaWrapper);
    });
  }

  // H√†m n√†y r·∫•t quan tr·ªçng: n√≥ c·∫≠p nh·∫≠t l·∫°i ƒë·ªëi t∆∞·ª£ng FileList trong th·∫ª <input>
  // v√¨ FileList m·∫∑c ƒë·ªãnh l√† ch·ªâ ƒë·ªçc (read-only).
  function updateFileInput() {
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => {
          dataTransfer.items.add(file);
      });
      // G√°n danh s√°ch file m·ªõi v√†o input
      fileInput.files = dataTransfer.files;
  }
});
</script>
{# === K·∫æT TH√öC: SCRIPT M·ªöI === #}
{% endblock %}