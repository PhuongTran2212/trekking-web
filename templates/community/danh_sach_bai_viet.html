{% extends 'base.html' %} 
{% load static %} 

{% block title %} C·ªông ƒë·ªìng - Chia s·∫ª tr·∫£i nghi·ªám {% endblock %} 

{% block extra_css %}
    {# Th√™m CSS cho tag n·∫øu b·∫°n ch∆∞a c√≥ file css chung #}
    <style>
      .tag-badge-sm {
        display: inline-block;
        padding: 0.25em 0.5em;
        font-size: .70em;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        border-radius: 0.25rem;
        background-color: #6c757d;
        text-decoration: none;
        margin-right: 4px;
      }
      .tag-badge-sm:hover {
        background-color: #5a6268;
        color: #fff;
      }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      {# Header #}
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üåÑ C·ªông ƒë·ªìng Trekking</h2>
        {% if user.is_authenticated %}
        <a href="{% url 'community:tao-bai-viet' %}" class="btn btn-primary">
          ‚úçÔ∏è T·∫°o b√†i vi·∫øt m·ªõi
        </a>
        {% endif %}
      </div>

      {# Search bar #}
      <form method="get" class="mb-4">
        <div class="input-group">
          <input
            type="text"
            name="search"
            class="form-control"
            placeholder="T√¨m ki·∫øm b√†i vi·∫øt..."
            value="{{ search_query }}"
          />
          <button class="btn btn-outline-secondary" type="submit">
            üîç T√¨m ki·∫øm
          </button>
        </div>
      </form>

      {# Danh s√°ch b√†i vi·∫øt #} 
      {% if bai_viet %} 
        {% for post in bai_viet %}
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-start">
              {# Avatar #}
              <div class="me-3">
                <div
                  class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                  style="width: 50px; height: 50px; font-size: 20px"
                >
                  {{ post.tac_gia.username|slice:":1"|upper }}
                </div>
              </div>

              {# N·ªôi dung #}
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h5 class="mb-1">
                      <a
                        href="{% url 'community:chi-tiet-bai-viet' post.id %}"
                        class="text-decoration-none text-dark"
                      >
                        {{ post.tieu_de }}
                      </a>
                    </h5>
                    <small class="text-muted">
                      B·ªüi <strong>{{ post.tac_gia.username }}</strong> ‚Ä¢ {{
                      post.ngay_dang|date:"d/m/Y H:i" }} {% if post.chuyen_di %} ‚Ä¢
                      üèîÔ∏è <a href="#">{{ post.chuyen_di.ten }}</a>{% endif %}
                    </small>
                  </div>
                </div>

                <p class="mt-2 mb-2">{{ post.noi_dung|truncatewords:30 }}</p>

                <!-- === B·∫ÆT ƒê·∫¶U: KH·ªêI M√É M·ªöI HI·ªÇN TH·ªä TAGS === -->
                {% if post.tags.all %}
                <div class="mb-2">
                  {% for tag in post.tags.all %}
                  <a href="{% url 'community:danh-sach-bai-viet' %}?tag={{ tag.slug }}" class="tag-badge-sm">
                    #{{ tag.ten }}
                  </a>
                  {% endfor %}
                </div>
                {% endif %}
                <!-- === K·∫æT TH√öC: KH·ªêI M√É M·ªöI HI·ªÇN TH·ªä TAGS === -->

                {# Media preview #} 
                {% if post.media.all %}
                <div class="row g-2 mb-2">
                  {% for media in post.media.all|slice:":3" %}
                  <div class="col-4">
                    {% if media.loai_media == 'anh' %}
                    <img
                      src="{{ media.duong_dan_file.url }}"
                      class="img-fluid rounded"
                      style="max-height: 150px; object-fit: cover; width: 100%"
                    />
                    {% else %}
                    <video
                      class="img-fluid rounded"
                      style="max-height: 150px; object-fit: cover; width: 100%"
                      controls
                    >
                      <source
                        src="{{ media.duong_dan_file.url }}"
                        type="video/mp4"
                      />
                    </video>
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
                {% endif %}

                <div class="d-flex gap-3 text-muted">
                  <span
                    ><i class="bi bi-arrow-up-circle"></i> {{ post.luot_binh_chon
                    }} upvote</span
                  >
                  <span
                    ><i class="bi bi-chat"></i> {{ post.so_luong_binh_luan }} b√¨nh
                    lu·∫≠n</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %} {# Ph√¢n trang #} {% if bai_viet.has_other_pages %}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if bai_viet.has_previous %}
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ bai_viet.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
            >
              Tr∆∞·ªõc
            </a>
          </li>
          {% endif %} {% for num in bai_viet.paginator.page_range %}
          <li
            class="page-item {% if bai_viet.number == num %}active{% endif %}"
          >
            <a
              class="page-link"
              href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}"
            >
              {{ num }}
            </a>
          </li>
          {% endfor %} {% if bai_viet.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ bai_viet.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
            >
              Sau
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %} {% else %}
      <div class="alert alert-info text-center">
        <h5>Ch∆∞a c√≥ b√†i vi·∫øt n√†o</h5>
        <p>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n!</p>
        {% if user.is_authenticated %}
        <a href="{% url 'community:tao-bai-viet' %}" class="btn btn-primary">
          T·∫°o b√†i vi·∫øt ƒë·∫ßu ti√™n
        </a>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
