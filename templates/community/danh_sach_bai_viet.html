{% extends 'base.html' %} 
{% load static %} 

{% block title %}Cộng đồng - Chia sẻ trải nghiệm{% endblock %} 

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/community.css' %}">
<style>
    /* Thêm CSS cho phần hiển thị avatar và link xem thêm */
    .post-author-avatar {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, var(--primary-light), var(--primary-medium));
        color: var(--primary-darkest);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
        overflow: hidden;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--radius-full);
    }

    /* Style cho link xem chi tiết */
    .read-more-link {
        font-size: 0.9rem;
        color: var(--primary-dark);
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin-top: 0.5rem;
        transition: all 0.2s;
    }
    .read-more-link:hover {
        color: var(--primary-medium);
        transform: translateX(5px);
    }
    
    /* Style cho đoạn trích dẫn */
    .post-excerpt {
        color: #555;
        line-height: 1.5;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="community-header mb-5">
        <div class="d-flex justify-between align-center flex-wrap gap-3">
            <div>
                <h1 class="mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5rem; color: var(--primary-dark);">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Cộng đồng Trekking
                </h1>
                <p class="text-muted mb-0">Chia sẻ trải nghiệm và kết nối với những người yêu thiên nhiên</p>
            </div>
            {% if user.is_authenticated %}
            <a href="{% url 'community:tao-bai-viet' %}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
                Tạo bài viết mới
            </a>
            {% endif %}
        </div>
    </div>

    <form method="get" class="mb-4">
        <div class="search-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input
                type="text"
                name="search"
                class="form-control"
                placeholder="Tìm kiếm bài viết, địa điểm, trải nghiệm..."
                value="{{ search_query }}"
                style="padding-left: 2.75rem;"
            />
        </div>
    </form>

    {% if bai_viet %} 
        <div class="posts-list">
            {% for post in bai_viet %}
<article class="community-post-card animate-fadeInUp">
    <div class="d-flex gap-3">
        <!-- Avatar -->
        <div class="post-author-avatar">
            {% if post.tac_gia.taikhoanhoso.anh_dai_dien %}
                <img src="{{ post.tac_gia.taikhoanhoso.anh_dai_dien.url }}" alt="{{ post.tac_gia.username }}" class="avatar-img">
            {% else %}
                <img src="/static/images/default_avatar.png" alt="{{ post.tac_gia.username }}" class="avatar-img">
            {% endif %}
        </div>

        <div class="flex-grow-1">
            <div class="post-card-header">
                <div>
                    <h3 class="post-list-title mb-1">
                        <a href="{% url 'community:chi-tiet-bai-viet' post.id %}">
                            {{ post.tieu_de }}
                        </a>
                    </h3>
                    <div class="post-meta-info">
                        <span class="font-semibold">{{ post.tac_gia.get_full_name|default:post.tac_gia.username }}</span>
                        <span>&middot;</span>
                        <span>{{ post.ngay_dang|date:"d/m/Y H:i" }}</span>
                        {% if post.chuyen_di %}
                            <span>&middot;</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <a href="#">{{ post.chuyen_di.ten }}</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- === PHẦN SỬA LẠI === -->
            <!-- Thêm |safe để hiển thị đúng tiếng Việt có dấu -->
            <p class="post-excerpt mt-2 mb-2">
                {{ post.noi_dung|safe|striptags|truncatewords:40 }}
            </p>
            <!-- ==================== -->

            <a href="{% url 'community:chi-tiet-bai-viet' post.id %}" class="read-more-link mb-3">
                Xem chi tiết 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 4px;">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
            </a>

            <!-- Các phần Tags, Media, Stats giữ nguyên -->
            {% if post.tags.all %}
            <div class="post-tags-inline mb-3">
                {% for tag in post.tags.all %}
                <a href="{% url 'community:danh-sach-bai-viet' %}?tag={{ tag.slug }}" class="badge badge-primary">
                    #{{ tag.ten }}
                </a>
                {% endfor %}
            </div>
            {% endif %}

            <!-- (Phần hiển thị media preview giữ nguyên...) -->
             {% if post.media.all %}
            <div class="post-media-preview mb-3">
                {% for media in post.media.all|slice:":3" %}
                <div class="media-preview-item">
                    {% if media.loai_media == 'anh' %}
                    <img src="{{ media.duong_dan_file.url }}" alt="Media preview" loading="lazy" />
                    {% else %}
                    <video>
                        <source src="{{ media.duong_dan_file.url }}" type="video/mp4" />
                    </video>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="post-stats">
                <span class="stat-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                    </svg>
                    {{ post.luot_binh_chon }}
                </span>
                <span class="stat-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    {{ post.so_luong_binh_luan }}
                </span>
            </div>
        </div>
    </div>
</article>
            {% endfor %}
        </div>

        {% if bai_viet.has_other_pages %}
        <nav aria-label="Phân trang" class="mt-5">
            <ul class="pagination">
                {% if bai_viet.has_previous %}
                <li class="pagination-item">
                    <a href="?page={{ bai_viet.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                        Trước
                    </a>
                </li>
                {% endif %}
                
                {% for num in bai_viet.paginator.page_range %}
                <li class="pagination-item {% if bai_viet.number == num %}active{% endif %}">
                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">
                        {{ num }}
                    </a>
                </li>
                {% endfor %}
                
                {% if bai_viet.has_next %}
                <li class="pagination-item">
                    <a href="?page={{ bai_viet.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                        Sau
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="card text-center p-5">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1.5rem; color: var(--gray-400);">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                <line x1="9" y1="10" x2="15" y2="10"></line>
                <line x1="12" y1="7" x2="12" y2="13"></line>
            </svg>
            <h3 class="mb-3">Chưa có bài viết nào</h3>
            <p class="text-muted mb-4">Hãy là người đầu tiên chia sẻ trải nghiệm của bạn!</p>
            {% if user.is_authenticated %}
            <a href="{% url 'community:tao-bai-viet' %}" class="btn btn-primary">
                Tạo bài viết đầu tiên
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}