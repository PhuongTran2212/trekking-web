{% extends 'admin_base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
    <!-- 1. Thư viện Bản đồ Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 2. Thư viện Ảnh LightGallery -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/css/lightgallery-bundle.min.css" />
    
    <style>
        #map { 
            height: 350px; 
            border-radius: 8px; 
            border: 1px solid #dee2e6;
        }
        
        /* === CSS NÂNG CẤP CHO THƯ VIỆN ẢNH (HIỂN THỊ 5 ẢNH) === */
        .smart-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        .gallery-item {
            position: relative; width: 100%; padding-top: 100%;
            border-radius: 8px; overflow: hidden; cursor: pointer;
            display: none; /* Mặc định ẩn tất cả */
        }
        /* Chỉ hiển thị 5 item đầu tiên */
        .gallery-item:nth-child(-n+5) {
            display: block;
        }
        .gallery-item img {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.3s ease;
        }
        .gallery-item:hover img { transform: scale(1.05); }
        .gallery-item-more-overlay {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            background-color: rgba(0,0,0,0.6); color: white;
            font-size: 2rem; font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .gallery-item:hover .gallery-item-more-overlay {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">{{ page_title }}</h4>
        <div>
            <a href="{% url 'treks_admin:cung_duong_update' trek.pk %}" class="btn btn-secondary">Chỉnh sửa</a>
            <a href="{% url 'treks_admin:cung_duong_list' %}" class="btn btn-ghost">Quay lại danh sách</a>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <!-- ẢNH BÌA -->
                {% with cover_media=trek.cover_media %}
                    {% if cover_media %}
                        <img src="{{ cover_media.file.url }}" alt="Ảnh bìa của {{ trek.ten }}" class="img-fluid rounded mb-4" style="max-height: 400px; width: 100%; object-fit: cover;">
                    {% else %}
                        <div class="alert alert-secondary">Chưa có ảnh bìa.</div>
                    {% endif %}
                {% endwith %}
                <hr>

                <h5>Mô tả chi tiết</h5>
                <p>{{ trek.mo_ta|linebreaks }}</p>
                <hr>

                <h5>Vị trí trên bản đồ</h5>
                {% if trek.du_lieu_ban_do_geojson %}
                    <div id="map" class="mb-4"></div>
                {% else %}
                    <div class="alert alert-warning">Chưa có dữ liệu bản đồ.</div>
                {% endif %}
                <hr>

                <!-- === THƯ VIỆN MEDIA VỚI LOGIC HIỂN THỊ MỚI (5 ẢNH) === -->
                <h5>Thư viện Media</h5>
                {% with gallery=trek.gallery_media %}
                    <div id="lightgallery" class="smart-gallery">
                        {% for media in gallery %}
                            <a class="gallery-item" href="{{ media.file.url }}" data-sub-html="<h4>{{ trek.ten }}</h4>">
                                <img src="{{ media.file.url }}" />
                                {% if forloop.counter == 5 and gallery.count > 5 %}
                                    <div class="gallery-item-more-overlay">
                                        +{{ gallery.count|add:"-5" }}
                                    </div>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                    {% if not gallery %}
                        <p class="text-muted">Thư viện media trống.</p>
                    {% endif %}
                {% endwith %}
            </div>

            <!-- CỘT PHẢI: THÔNG TIN TÓM TẮT -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header"><h5 class="mb-0">Thông tin cơ bản</h5></div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            {% if trek.tinh_thanh %}<li><strong>Tỉnh/Thành:</strong> {{ trek.tinh_thanh.ten }}</li>{% endif %}
                            {% if trek.do_kho %}<li><strong>Độ khó:</strong> {{ trek.do_kho.ten }}</li>{% endif %}
                            <li><strong>Trạng thái:</strong> 
                                {% if trek.trang_thai == 'DA_DUYET' %}<span class="badge bg-success">{{ trek.get_trang_thai_display }}</span>
                                {% elif trek.trang_thai == 'CHO_DUYET' %}<span class="badge bg-warning text-dark">{{ trek.get_trang_thai_display }}</span>
                                {% else %}<span class="badge bg-danger">{{ trek.get_trang_thai_display }}</span>
                                {% endif %}
                            </li>
                            <li><strong>Đánh giá:</strong> 
                                {{ trek.danh_gia_trung_binh|floatformat:1 }} ★ 
                                <small class="text-muted">({{ trek.so_luot_danh_gia }} lượt)</small>
                            </li>
                            <hr>
                            <li><strong>Độ dài (khứ hồi):</strong> {{ trek.do_dai_km|floatformat:2 }} km</li>
                            <li><strong>Thời gian:</strong> {{ trek.thoi_gian_uoc_tinh_gio }} giờ</li>
                            <li><strong>Độ cao leo:</strong> {{ trek.tong_do_cao_leo_m|default:"N/A" }} m</li>
                            <li><strong>Mùa đẹp nhất:</strong> {{ trek.mua_dep_nhat|default:"N/A" }}</li>
                        </ul>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header"><h5 class="mb-0">Vật dụng gợi ý</h5></div>
                    <div class="card-body">
                        {% if trek.vat_dung_goi_y.all %}
                        <ul class="list-unstyled">
                            {% for item in trek.vat_dung_goi_y.all %}
                                <li>- {{ item.vat_dung.ten }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                            <p class="mb-0 text-muted">Chưa có gợi ý vật dụng.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <hr>

        <!-- PHẦN ĐÁNH GIÁ -->
        <h5>Đánh giá của người dùng ({{ total_reviews }})</h5>
        {% for review in reviews %}
            <div class="card mb-3">
                <div class="card-body">
                    <p class="mb-1">
                        <strong>{{ review.user.username|default:"[Người dùng ẩn danh]" }}</strong> - 
                        <span class="text-warning">
                            {% for i in "12345" %}{% if forloop.counter <= review.diem_danh_gia %}★{% else %}☆{% endif %}{% endfor %}
                        </span>
                    </p>
                    <small class="text-muted d-block mb-2">{{ review.ngay_danh_gia|date:"H:i, d/m/Y" }}</small>
                    <p class="mb-0">{{ review.binh_luan|linebreaks }}</p>
                </div>
            </div>
        {% empty %}
            <p>Chưa có đánh giá nào.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Script LightGallery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/lightgallery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/zoom/lg-zoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/thumbnail/lg-thumbnail.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    
    /**
     * KHỞI TẠO BẢN ĐỒ XEM TRƯỚC
     */
    const mapElement = document.getElementById('map');
    const geojsonDataString = `{{ trek.du_lieu_ban_do_geojson|escapejs }}`;
    
    if (mapElement && geojsonDataString && geojsonDataString !== 'None') {
        try {
            const geojsonData = JSON.parse(geojsonDataString);
            if (geojsonData && geojsonData.features && geojsonData.features.length > 0) {
                const feature = geojsonData.features[0];
                if (feature.geometry && feature.geometry.type === 'LineString' && feature.geometry.coordinates.length > 1) {
                    const map = L.map(mapElement, { scrollWheelZoom: false, dragging: true, zoomControl: true });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                    const routeLayer = L.geoJSON(geojsonData, { style: () => ({ color: '#EF4444', weight: 5, opacity: 0.8 }) }).addTo(map);

                    const coords = feature.geometry.coordinates;
                    const startLatLng = L.latLng(coords[0][1], coords[0][0]);
                    const endLatLng = L.latLng(coords[coords.length - 1][1], coords[coords.length - 1][0]);

                    const startIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] });
                    const endIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] });

                    L.marker(startLatLng, { icon: startIcon }).addTo(map).bindPopup('Điểm bắt đầu');
                    L.marker(endLatLng, { icon: endIcon }).addTo(map).bindPopup('Điểm kết thúc');

                    setTimeout(() => { map.fitBounds(routeLayer.getBounds()); }, 100);
                }
            }
        } catch (e) { console.error("Lỗi khi xử lý dữ liệu bản đồ:", e); }
    }

    /**
     * KHỞI TẠO THƯ VIỆN ẢNH (ĐÃ XÓA NÚT XÓA)
     */
    const lgContainer = document.getElementById('lightgallery');
    if (lgContainer) {
        lightGallery(lgContainer, {
            plugins: [lgZoom, lgThumbnail],
            speed: 500,
            download: true,
            selector: '.gallery-item'
        });
    }
});
</script>
{% endblock %}