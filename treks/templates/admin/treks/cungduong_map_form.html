{% extends 'admin_base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #map { height: 500px; border-radius: 8px; }
    .search-results-wrapper { position: relative; }
    #search-results {
        max-height: 250px; overflow-y: auto;
        position: absolute; left: 0; right: 0; z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 0 0 8px 8px;
    }
    #search-results .list-group-item { cursor: pointer; }
    #search-results .list-group-item:hover { background-color: #f0f0f0; }

    #location-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    #location-info h6 { margin-bottom: 0.5rem; }
    #location-info p { margin-bottom: 0.25rem; font-size: 0.9rem; word-break: break-all; }
    #location-info .text-muted { font-style: italic; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h4 class="mb-0">{{ page_title }}</h4></div>
    <form method="post">
        {% csrf_token %}
        <div class="card-body p-4">
            <p>Sử dụng ô tìm kiếm hoặc click trực tiếp lên bản đồ để chọn và tự động nhận diện vị trí. Nhấn "Lưu Vị Trí" khi hoàn tất.</p>
            <div class="form-group search-results-wrapper mb-3">
                <div class="input-group">
                    <input type="text" id="map-search-input" class="form-control" placeholder="Nhập địa danh để tìm kiếm...">
                    <button type="button" id="search-btn" class="btn btn-info">Tìm</button>
                </div>
                <div id="search-results" class="list-group"></div>
            </div>
            <div id="map"></div>
            <div id="location-info" class="mt-3">
                <h6>Thông tin vị trí đã chọn</h6>
                <div id="location-details"><p class="text-muted">Chưa có vị trí nào được chọn.</p></div>
            </div>
            {{ form.du_lieu_ban_do_geojson }}
        </div>
        <div class="card-footer text-end">
            <a href="{% url 'treks_admin:cung_duong_detail' pk=object.pk %}" class="btn btn-secondary">Quay lại</a>
            <button type="submit" class="btn btn-primary">Lưu Vị Trí</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (khai báo các biến không đổi)
    const map = L.map('map').setView([21.0285, 105.8542], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    setTimeout(() => map.invalidateSize(), 150);
    let marker = null;
    const geojsonInput = document.getElementById('id_du_lieu_ban_do_geojson');
    const searchInput = document.getElementById('map-search-input');
    const searchBtn = document.getElementById('search-btn');
    const resultsContainer = document.getElementById('search-results');
    const locationDetailsDiv = document.getElementById('location-details');

    /**
     * Hàm này không thay đổi, nó chỉ chịu trách nhiệm hiển thị
     */
    function updateDisplay(latLng, locationName) {
        if (marker) map.removeLayer(marker);
        
        const lat = latLng.lat.toFixed(6);
        const lng = latLng.lng.toFixed(6);
        const popupContent = `<div style="font-weight: bold; margin-bottom: 5px; max-width: 250px; white-space: normal;">${locationName}</div><div><strong>Tọa độ:</strong> ${lat}, ${lng}</div>`;
        
        marker = L.marker(latLng).addTo(map);
        marker.bindPopup(popupContent).openPopup();
        map.setView(latLng, 14); // Zoom gần hơn khi có kết quả

        const geojsonPoint = {"type": "FeatureCollection", "features": [{"type": "Feature", "properties": {}, "geometry": {"type": "Point", "coordinates": [parseFloat(lng), parseFloat(lat)]}}]};
        geojsonInput.value = JSON.stringify(geojsonPoint);
        
        locationDetailsDiv.innerHTML = `<p><strong>Vị trí:</strong> ${locationName}</p><p><strong>Tọa độ:</strong> ${lat}, ${lng}</p>`;
    }

    /**
     * ======================================================================
     * === HÀM MỚI: TÌM KIẾM NGƯỢC TỪ TỌA ĐỘ ===
     * ======================================================================
     */
    function reverseGeocode(latLng) {
        // Hiển thị tạm thời trong khi chờ API
        updateDisplay(latLng, "Đang tìm địa chỉ...");
        
        const apiUrl = `{% url 'treks_admin:nominatim_proxy' %}?lat=${latLng.lat}&lon=${latLng.lng}`;

        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
                let locationName = "Không xác định được vị trí";
                if (data && data.length > 0 && data[0].display_name) {
                    locationName = data[0].display_name;
                }
                // Cập nhật lại màn hình với tên địa chỉ vừa tìm được
                updateDisplay(latLng, locationName);
            })
            .catch(error => {
                console.error("Lỗi khi reverse geocode:", error);
                updateDisplay(latLng, "Lỗi khi tìm địa chỉ");
            });
    }

    function searchLocation() {
        const query = searchInput.value.trim();
        if (!query) return;
        resultsContainer.innerHTML = '<div class="list-group-item">Đang tìm...</div>';
        const apiUrl = `{% url 'treks_admin:nominatim_proxy' %}?q=${encodeURIComponent(query)}`;
        fetch(apiUrl).then(res => res.json()).then(data => {
            resultsContainer.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(place => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action';
                    item.href = '#';
                    item.innerText = place.display_name;
                    item.onclick = (e) => {
                        e.preventDefault();
                        // Thay vì gọi updateMarkerAndGeoJSON, bây giờ chỉ cần gọi updateDisplay
                        updateDisplay(L.latLng(place.lat, place.lon), place.display_name);
                        resultsContainer.innerHTML = '';
                        searchInput.value = '';
                    };
                    resultsContainer.appendChild(item);
                });
            } else { resultsContainer.innerHTML = '<div class="list-group-item">Không tìm thấy.</div>'; }
        });
    }

    // Tải vị trí đã lưu nếu có
    if (geojsonInput.value) {
        try {
            const geojson = JSON.parse(geojsonInput.value);
            if (geojson && geojson.features && geojson.features.length > 0) {
                const coords = geojson.features[0].geometry.coordinates;
                // Gọi hàm updateDisplay để hiển thị thông tin ban đầu
                updateDisplay(L.latLng(coords[1], coords[0]), 'Vị trí đã lưu');
            }
        } catch(e) {}
    }

    // === THAY ĐỔI QUAN TRỌNG: SỰ KIỆN CLICK TRÊN BẢN ĐỒ ===
    map.on('click', e => reverseGeocode(e.latlng));
    
    // Các sự kiện khác không đổi
    searchBtn.addEventListener('click', searchLocation);
    searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); searchLocation(); } });
    document.addEventListener('click', function(event) { if (!event.target.closest('.search-results-wrapper')) { resultsContainer.innerHTML = ''; } });
});
</script>
{% endblock %}