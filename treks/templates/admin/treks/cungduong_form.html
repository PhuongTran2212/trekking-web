{% extends 'admin_base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<!-- Thư viện bản đồ Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #map { height: 400px; border-radius: var(--radius-md); }
    .preview-image { width: 150px; height: 100px; object-fit: cover; margin-top: 10px; border-radius: 5px; }
    .vat-dung-list { columns: 2; -webkit-columns: 2; -moz-columns: 2; }
    .vat-dung-list div { display: block; }
</style>
{% endblock %}

{% block content %}
<!-- === FORM CHÍNH: Dùng để SỬA và TẢI LÊN file mới === -->
<div class="card">
    <div class="card-header"><h4 class="mb-0">{{ page_title }}</h4></div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card-body">
            {% if form.errors %}<div class="alert alert-danger">Vui lòng sửa các lỗi bên dưới.</div>{% endif %}
            <div class="row">
                <!-- Cột trái -->
                <div class="col-8">
                    <div class="form-group mb-3">{{ form.ten.label_tag }} {{ form.ten }}</div>
                    <div class="form-group mb-3">{{ form.mo_ta.label_tag }} {{ form.mo_ta }}</div>

                    <div class="card mt-4">
                        <div class="card-header"><h6 class="mb-0">Bản đồ</h6></div>
                        <div class="card-body">
                            <div class="form-group">
                                {{ form.dia_diem_chi_tiet.label_tag }}
                                <div class="input-group">
                                    {{ form.dia_diem_chi_tiet }}
                                    <button type="button" id="find-on-map-btn" class="btn btn-info">Tìm</button>
                                </div>
                            </div>
                            <div id="map" class="mt-3"></div>
                            <div class="d-none">{{ form.du_lieu_ban_do_geojson }}</div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header"><h6 class="mb-0">Tải lên / Thay đổi Media</h6></div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label fw-bold">Tải lên hoặc thay thế ảnh bìa</label>
                                <input type="file" name="anh_bia" id="cover-upload" class="form-control" accept="image/*">
                                <div id="cover-preview" class="mt-2"></div>
                            </div>
                            <hr>
                            <div class="form-group">
                                <label class="form-label fw-bold">Thêm ảnh/video mới vào thư viện</label>
                                <input type="file" name="file" id="gallery-upload" class="form-control" multiple>
                                <div id="gallery-preview" class="mt-2 d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cột phải -->
                <div class="col-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Thuộc tính</h6></div>
                        <div class="card-body">
                            <div class="form-group mb-3">{{ form.tinh_thanh.label_tag }}{{ form.tinh_thanh }}</div>
                            <div class="form-group mb-3">{{ form.do_kho.label_tag }}{{ form.do_kho }}</div>
                            <hr>
                            <div class="form-group mb-3">{{ form.do_dai_km.label_tag }}{{ form.do_dai_km }}</div>
                            <div class="form-group mb-3">{{ form.thoi_gian_uoc_tinh_gio.label_tag }}{{ form.thoi_gian_uoc_tinh_gio }}</div>
                            <div class="form-group mb-3">{{ form.tong_do_cao_leo_m.label_tag }}{{ form.tong_do_cao_leo_m }}</div>
                            <div class="form-group mb-3">{{ form.mua_dep_nhat.label_tag }}{{ form.mua_dep_nhat }}</div>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header"><h6 class="mb-0">Vật dụng gợi ý</h6></div>
                        <div class="card-body vat-dung-list" style="max-height: 400px; overflow-y: auto;">
                            {{ form.vat_dung_goi_y }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <a href="{% if object %}{% url 'treks_admin:cung_duong_detail' pk=object.pk %}{% else %}{% url 'treks_admin:cung_duong_list' %}{% endif %}" class="btn btn-ghost">Hủy</a>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
        </div>
    </form>
</div>


<!-- === KHU VỰC QUẢN LÝ MEDIA HIỆN CÓ - HOÀN TOÀN TÁCH BIỆT KHỎI FORM CHÍNH === -->
{% if object %}
<div class="card mt-4">
    <div class="card-header"><h6 class="mb-0">Media hiện có</h6></div>
    <div class="card-body">
        <!-- PHẦN 1: ẢNH BÌA -->
        <h6 class="mb-3">Ảnh bìa</h6>
        {% with cover_media=object.cover_media %}
            {% if cover_media %}
                <div class="position-relative d-inline-block mb-3">
                    <img src="{{ cover_media.file.url }}" class="img-thumbnail" style="width: 200px; height: 150px; object-fit: cover;">
                    <!-- Nút xóa có FORM RIÊNG, không lồng vào form chính -->
                    <form method="POST" action="{% url 'treks_admin:cung_duong_media_delete_now' pk=cover_media.pk %}" onsubmit="return confirm('Bạn có chắc muốn xóa ảnh bìa này không?');" class="position-absolute" style="top: -10px; right: -10px;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; padding: 0;">&times;</button>
                    </form>
                </div>
            {% else %}
                <p class="text-muted">Chưa có ảnh bìa.</p>
            {% endif %}
        {% endwith %}
        <hr>

        <!-- PHẦN 2: THƯ VIỆN MEDIA -->
        <h6 class="mb-3">Thư viện Media</h6>
        {% with gallery_media=object.media.all %}
            {% if gallery_media|length > 1 or not object.cover_media %} {# Chỉ hiển thị nếu có ảnh khác ngoài ảnh bìa #}
            <div class="d-flex flex-wrap gap-4">
                {% for media in gallery_media %}
                    {% if not media.la_anh_bia %}
                    <div class="position-relative">
                        <a href="{{ media.file.url }}" target="_blank">
                            <img src="{{ media.file.url }}" alt="{{ media.file.name }}" style="width: 120px; height: 120px; object-fit: cover; border-radius: var(--radius-md);">
                        </a>
                        <!-- MỖI NÚT XÓA CÓ FORM RIÊNG, không lồng vào form chính -->
                        <form method="POST" action="{% url 'treks_admin:cung_duong_media_delete_now' pk=media.pk %}" onsubmit="return confirm('Bạn có chắc muốn xóa file này không?');" class="position-absolute" style="top: -10px; right: -10px;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; padding: 0;">&times;</button>
                        </form>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">Thư viện media trống.</p>
            {% endif %}
        {% endwith %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 1. Script cho Image Preview khi chọn file mới
    function setupImagePreview(inputId, previewId, isSingle) {
        const uploader = document.getElementById(inputId);
        const previewer = document.getElementById(previewId);
        if (!uploader) return;
        uploader.addEventListener('change', function(event) {
            if (isSingle) { previewer.innerHTML = ''; }
            for (const file of event.target.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    previewer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    setupImagePreview('cover-upload', 'cover-preview', true);
    setupImagePreview('gallery-upload', 'gallery-preview', false);

    // 2. Script cho Leaflet Map
    const mapElement = document.getElementById('map');
    if (mapElement) {
        const map = L.map(mapElement).setView([21.0285, 105.8542], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = null;
        const geojsonInput = document.getElementById('id_du_lieu_ban_do_geojson');
        function updateMapFromGeoJSON(geojsonStr) { if (marker) map.removeLayer(marker); try { const geojson = JSON.parse(geojsonStr); if (geojson && geojson.features && geojson.features.length > 0) { const coords = geojson.features[0].geometry.coordinates; const latLng = [coords[1], coords[0]]; map.setView(latLng, 14); marker = L.marker(latLng).addTo(map); } } catch (e) { /* ignore */ } }
        if (geojsonInput && geojsonInput.value) { updateMapFromGeoJSON(geojsonInput.value); }
        document.getElementById('find-on-map-btn').addEventListener('click', function () { const address = document.getElementById('id_dia_diem_chi_tiet').value; if (!address) { alert('Vui lòng nhập địa điểm.'); return; } fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`).then(res => res.json()).then(data => { if (data && data.length > 0) { const { lat, lon, display_name } = data[0]; const latLng = [parseFloat(lat), parseFloat(lon)]; map.setView(latLng, 14); if (marker) map.removeLayer(marker); marker = L.marker(latLng).addTo(map).bindPopup(display_name).openPopup(); const geojsonPoint = { "type": "FeatureCollection", "features": [{ "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [parseFloat(lon), parseFloat(lat)] } }] }; if (geojsonInput) { geojsonInput.value = JSON.stringify(geojsonPoint); } } else { alert('Không tìm thấy địa điểm.'); } }).catch(err => console.error('Lỗi khi tìm địa điểm:', err)); });
    }
});
</script>
{% endblock %}