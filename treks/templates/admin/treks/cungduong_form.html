{% extends 'admin_base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<!-- Thư viện bản đồ Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
   
<style>
    #map { height: 400px; border-radius: var(--radius-md); }
    .preview-image { width: 150px; height: 100px; object-fit: cover; margin-top: 10px; border-radius: 5px; }
    .vat-dung-list { columns: 2; -webkit-columns: 2; -moz-columns: 2; }
    .vat-dung-list div { display: block; }
    .search-results-wrapper { position: relative; }
    #search-results {
        max-height: 250px; overflow-y: auto; border-top: none;
        position: absolute; left: 0; right: 0; z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 0 0 var(--radius-md) var(--radius-md);
    }
    #search-results .list-group-item { cursor: pointer; }
    #search-results .list-group-item:hover { background-color: #f0f0f0; }
</style>
{% endblock %}

{% block content %}

<!-- === FORM CHÍNH === -->
<div class="card">
    <div class="card-header"><h4 class="mb-0">{{ page_title }}</h4></div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card-body">
            {% if form.errors %}<div class="alert alert-danger">Vui lòng sửa các lỗi bên dưới.</div>{% endif %}
            <div class="row">
                <!-- Cột trái -->
                <div class="col-8">
                    <div class="form-group mb-3">{{ form.ten.label_tag }} {{ form.ten }}</div>
                    <div class="form-group mb-3">{{ form.mo_ta.label_tag }} {{ form.mo_ta }}</div>
                    <div class="form-group mb-3">{{ form.dia_diem_chi_tiet.label_tag }} {{ form.dia_diem_chi_tiet }}</div>

                    <div class="card mt-4">
                        <div class="card-header"><h6 class="mb-0">Bản đồ</h6></div>
                        <div class="card-body">
                            <div class="form-group search-results-wrapper">
                                <label for="map-search-input" class="form-label fw-bold">Tìm vị trí & ghim lên bản đồ</label>
                                <div class="input-group">
                                    <input type="text" id="map-search-input" class="form-control" placeholder="Nhập địa danh để tìm kiếm, ví dụ: Fansipan..." autocomplete="off">
                                    <button type="button" id="find-on-map-btn" class="btn btn-info">Tìm</button>
                                </div>
                                <div id="search-results" class="list-group"></div>
                                <small class="form-text text-muted">Click vào kết quả để ghim, hoặc click trực tiếp lên bản đồ để chọn tọa độ.</small>
                            </div>
                            <div id="map" class="mt-3"></div>
                            {{ form.du_lieu_ban_do_geojson }}
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header"><h6 class="mb-0">Tải lên / Thay đổi Media</h6></div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label fw-bold">Tải lên hoặc thay thế ảnh bìa</label>
                                <input type="file" name="anh_bia" id="cover-upload" class="form-control" accept="image/*">
                                <div id="cover-preview" class="mt-2"></div>
                            </div>
                            <hr>
                            <div class="form-group">
                                <label class="form-label fw-bold">Thêm ảnh/video mới vào thư viện</label>
                                <input type="file" name="file" id="gallery-upload" class="form-control" multiple>
                                <div id="gallery-preview" class="mt-2 d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =========================================== -->
                <!-- === CỘT PHẢI (ĐÃ CẬP NHẬT VỚI TRƯỜNG TRẠNG THÁI) === -->
                <!-- =========================================== -->
                <div class="col-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Thuộc tính & Trạng thái</h6></div>
                        <div class="card-body">
               <!-- ======================================= -->
            <!-- === TRƯỜNG TRẠNG THÁI ĐƯỢC THÊM VÀO ĐÂY === -->
            <!-- ======================================= -->
            <div class="form-group mb-3">
                <label for="id_trang_thai" class="form-label">Trạng thái duyệt</label>
                {{ form.trang_thai }}
                {% if form.trang_thai.errors %}
                    <div class="invalid-feedback d-block">{{ form.trang_thai.errors|striptags }}</div>
                {% endif %}
            </div>
            <hr>
            <!-- ======================================= -->
                            <!-- Các trường thuộc tính khác -->
                            <div class="form-group mb-3">{{ form.tinh_thanh.label_tag }}{{ form.tinh_thanh }}</div>
                            <div class="form-group mb-3">{{ form.do_kho.label_tag }}{{ form.do_kho }}</div>
                            <hr>
                            <div class="form-group mb-3">{{ form.do_dai_km.label_tag }}{{ form.do_dai_km }}</div>
                            <div class="form-group mb-3">{{ form.thoi_gian_uoc_tinh_gio.label_tag }}{{ form.thoi_gian_uoc_tinh_gio }}</div>
                            <div class="form-group mb-3">{{ form.tong_do_cao_leo_m.label_tag }}{{ form.tong_do_cao_leo_m }}</div>
                            <div class="form-group mb-3">{{ form.mua_dep_nhat.label_tag }}{{ form.mua_dep_nhat }}</div>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header"><h6 class="mb-0">Vật dụng gợi ý</h6></div>
                        <div class="card-body vat-dung-list" style="max-height: 400px; overflow-y: auto;">
                            {{ form.vat_dung_goi_y }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <a href="{% if object %}{% url 'treks_admin:cung_duong_detail' pk=object.pk %}{% else %}{% url 'treks_admin:cung_duong_list' %}{% endif %}" class="btn btn-ghost">Hủy</a>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
        </div>
    </form>
</div>

<!-- === KHU VỰC QUẢN LÝ MEDIA HIỆN CÓ === -->
{% if object %}
<div class="card mt-4">
    <div class="card-header"><h6 class="mb-0">Media hiện có</h6></div>
    <div class="card-body">
        <h6 class="mb-3">Ảnh bìa</h6>
        {% with cover_media=object.cover_media %}
            {% if cover_media %}
                <div class="position-relative d-inline-block mb-3">
                    <img src="{{ cover_media.file.url }}" class="img-thumbnail" style="width: 200px; height: 150px; object-fit: cover;">
                    <form method="POST" action="{% url 'treks_admin:cung_duong_media_delete_now' pk=cover_media.pk %}" onsubmit="return confirm('Bạn có chắc muốn xóa ảnh bìa này không?');" class="position-absolute" style="top: -10px; right: -10px;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; padding: 0;">&times;</button>
                    </form>
                </div>
            {% else %}<p class="text-muted">Chưa có ảnh bìa.</p>{% endif %}
        {% endwith %}
        <hr>
        <h6 class="mb-3">Thư viện Media</h6>
        {% with gallery_media=object.media.all %}
            {% if gallery_media|length > 1 or not object.cover_media %}
            <div class="d-flex flex-wrap gap-4">
                {% for media in gallery_media %}
                    {% if not media.la_anh_bia %}
                    <div class="position-relative">
                        <a href="{{ media.file.url }}" target="_blank">
                            <img src="{{ media.file.url }}" alt="{{ media.file.name }}" style="width: 120px; height: 120px; object-fit: cover; border-radius: var(--radius-md);">
                        </a>
                        <form method="POST" action="{% url 'treks_admin:cung_duong_media_delete_now' pk=media.pk %}" onsubmit="return confirm('Bạn có chắc muốn xóa file này không?');" class="position-absolute" style="top: -10px; right: -10px;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; padding: 0;">&times;</button>
                        </form>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% else %}<p class="text-muted">Thư viện media trống.</p>{% endif %}
        {% endwith %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 1. Script cho Image Preview
    function setupImagePreview(inputId, previewId, isSingle) {
        const uploader = document.getElementById(inputId);
        const previewer = document.getElementById(previewId);
        if (!uploader) return;
        uploader.addEventListener('change', function(event) {
            if (isSingle) { previewer.innerHTML = ''; }
            for (const file of event.target.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    previewer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    setupImagePreview('cover-upload', 'cover-preview', true);
    setupImagePreview('gallery-upload', 'gallery-preview', false);

    // 2. Script cho Leaflet Map
    const mapElement = document.getElementById('map');
    if (mapElement) {
        const map = L.map(mapElement).setView([21.0285, 105.8542], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        setTimeout(() => map.invalidateSize(), 150);

        let marker = null;
        const geojsonInput = document.getElementById('id_du_lieu_ban_do_geojson');
        const searchInput = document.getElementById('map-search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const findButton = document.getElementById('find-on-map-btn');

        function updateMarkerAndGeoJSON(latLng, locationName = null) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(latLng).addTo(map);
            if (locationName) marker.bindPopup(locationName).openPopup();
            map.setView(latLng, 15);
            const geojsonPoint = { "type": "FeatureCollection", "features": [{"type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [latLng.lng, latLng.lat] }}] };
            if (geojsonInput) geojsonInput.value = JSON.stringify(geojsonPoint);
        }

        function loadInitialLocation() {
            if (geojsonInput && geojsonInput.value) {
                try {
                    const geojson = JSON.parse(geojsonInput.value);
                    if (geojson.features && geojson.features.length > 0) {
                        const coords = geojson.features[0].geometry.coordinates;
                        const latLng = L.latLng(coords[1], coords[0]);
                        const savedAddress = document.getElementById('id_dia_diem_chi_tiet').value;
                        updateMarkerAndGeoJSON(latLng, savedAddress || 'Vị trí đã lưu');
                    }
                } catch (e) { console.error("Lỗi đọc GeoJSON:", e); }
            }
        }

        findButton.addEventListener('click', function () {
            const query = searchInput.value;
            if (!query) { alert('Vui lòng nhập địa danh để tìm.'); return; }
            findButton.disabled = true;
            findButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            searchResultsContainer.innerHTML = '<div class="list-group-item">Đang tìm...</div>';
            const apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
            fetch(apiUrl, { headers: { 'User-Agent': 'TrekkingApp/1.0 (contact@example.com)' } })
                .then(res => res.json())
                .then(data => {
                    searchResultsContainer.innerHTML = '';
                    if (data && data.length > 0) {
                        data.slice(0, 5).forEach(result => {
                            const item = document.createElement('a');
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = result.display_name;
                            item.addEventListener('click', function (e) {
                                e.preventDefault();
                                const latLng = L.latLng(parseFloat(result.lat), parseFloat(result.lon));
                                updateMarkerAndGeoJSON(latLng, result.display_name);
                                searchResultsContainer.innerHTML = ''; searchInput.value = '';
                            });
                            searchResultsContainer.appendChild(item);
                        });
                    } else { searchResultsContainer.innerHTML = '<div class="list-group-item">Không tìm thấy kết quả.</div>'; }
                }).catch(err => {
                    searchResultsContainer.innerHTML = `<div class="list-group-item list-group-item-danger">Lỗi: ${err.message}</div>`;
                })
                .finally(() => { findButton.disabled = false; findButton.textContent = 'Tìm'; });
        });
        searchInput.addEventListener('keydown', function(event) { if (event.key === 'Enter') { event.preventDefault(); findButton.click(); } });
        document.addEventListener('click', function(event) { if (!event.target.closest('.search-results-wrapper')) { searchResultsContainer.innerHTML = ''; } });
        map.on('click', e => { updateMarkerAndGeoJSON(e.latlng, `Tọa độ đã chọn`); searchResultsContainer.innerHTML = ''; });
        loadInitialLocation();
    }
});
</script>
{% endblock %}