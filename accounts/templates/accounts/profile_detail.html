{% extends "base.html" %}
{% load static %}

{% block title %}Hồ sơ của {{ profile_user.username }}{% endblock %}

{% block extra_css %}
<style>
    .profile-grid { display: grid; grid-template-columns: 300px 1fr; gap: var(--spacing-xl); margin-top: var(--spacing-xl); }
    @media (max-width: 768px) { .profile-grid { grid-template-columns: 1fr; } }
    .profile-sidebar .card-body { text-align: center; }
    .profile-avatar { width: 128px; height: 128px; border-radius: 50%; object-fit: cover; margin: 0 auto var(--spacing-md); border: 4px solid white; box-shadow: var(--shadow-lg); }
    .profile-name { font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: var(--spacing-xs); }
    .profile-username { color: var(--gray-500); margin-bottom: var(--spacing-md); }
    .profile-bio { font-size: 0.9375rem; color: var(--gray-600); margin-bottom: var(--spacing-lg); line-height: 1.6; }
    .profile-stats { display: flex; justify-content: space-around; border-top: 1px solid var(--gray-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-lg); }
    .stat-item .value { font-size: 1.25rem; font-weight: 700; }
    .stat-item .label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; }
    .profile-tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: var(--spacing-lg); flex-wrap: wrap; }
    .tab-link { padding: 0.75rem 1.25rem; font-weight: 600; color: var(--gray-500); cursor: pointer; border-bottom: 2px solid transparent; transition: all var(--transition-fast); }
    .tab-link:hover { color: var(--primary-dark); }
    .tab-link.active { color: var(--primary-dark); border-bottom-color: var(--primary-dark); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeInUp 0.5s ease; }
    .activity-list .activity-item { padding: var(--spacing-md) 0; border-bottom: 1px solid var(--gray-100); }
    .activity-list .activity-item:last-child { border-bottom: none; }
    .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--spacing-md); }
    .badge-item { text-align: center; padding: var(--spacing-md); background-color: var(--gray-50); border-radius: var(--radius-lg); }
    .badge-item img { width: 64px; height: 64px; margin-bottom: var(--spacing-sm); }
    .badge-item .name { font-weight: 600; font-size: 0.875rem; }
    .badge-item .date { font-size: 0.75rem; color: var(--gray-500); }
    .section-title { font-family: var(--font-heading); font-size: 1.25rem; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--gray-200); }
    .equipment-list .item { display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; }
    .equipment-list .item-name { font-weight: 500; }
    .equipment-list .item-note { font-size: 0.875rem; color: var(--gray-500); margin-left: var(--spacing-sm); }
    .interests-list { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-grid">
        <!-- CỘT BÊN TRÁI: THÔNG TIN CÁ NHÂN -->
        <aside class="profile-sidebar">
            <div class="card">
                <div class="card-body">
                    
                    <!-- =================================================== -->
                    <!-- === THAY ĐỔI CHÍNH NẰM Ở DÒNG NÀY === -->
                    <!-- Chúng ta sử dụng thuộc tính .avatar_url đã tạo trong model, hoặc .anh_dai_dien.url -->
                    <img src="{{ profile_user.taikhoanhoso.avatar_url }}" alt="Avatar of {{ profile_user.username }}" class="profile-avatar">
                    <!-- =================================================== -->

                    <h1 class="profile-name">{{ profile_user.get_full_name|default:profile_user.username }}</h1>
                    <p class="profile-username">@{{ profile_user.username }}</p>

                    {% if profile_user.taikhoanhoso.tinh_thanh %}
                    <p class="text-sm text-muted d-flex align-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 16px; height: 16px;"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.223.654-.369.254-.145.532-.3.81-.468.277-.17.566-.35.85-.546l.122-.087a35.33 35.33 0 001.291-1.011c.424-.38.815-.792 1.158-1.245.343-.453.64-1. .886-1.465A9.416 9.416 0 0015 8.5a5 5 0 00-10 0c0 .98.22 1.923.622 2.774.246.465.543.912.886 1.465.343.453.734.865 1.158 1.245a35.33 35.33 0 001.291 1.011l.122.087c.285.196.573.375.85.546.278.168.556.323.81.468.254.146.468.269.654.369a5.741 5.741 0 00.28.14l.019.008.006.003zM10 11.25a2.75 2.75 0 100-5.5 2.75 2.75 0 000 5.5z" clip-rule="evenodd" /></svg>                          
                        {{ profile_user.taikhoanhoso.tinh_thanh.ten }}
                    </p>
                    {% endif %}
                    {% if is_own_profile and profile_user.taikhoanhoso.sdt %}
<p class="text-sm text-muted d-flex align-center justify-center gap-1 mt-2">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 16px; height: 16px;">
        <path d="M2 3.5A1.5 1.5 0 013.5 2h1.148a1.5 1.5 0 011.465 1.175l.716 3.223a1.5 1.5 0 01-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 006.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 011.767-1.052l3.223.716A1.5 1.5 0 0118 15.352V16.5a1.5 1.5 0 01-1.5 1.5h-1.5A13.5 13.5 0 012 3.5z" />
    </svg>
    {{ profile_user.taikhoanhoso.sdt }}
</p>
{% endif %}
                    <p class="profile-bio">{{ profile_user.taikhoanhoso.gioi_thieu|default:"Chưa có giới thiệu."|linebreaksbr }}</p>

                    {% if is_own_profile %}
                        <a href="{% url 'accounts:profile-update' %}" class="btn btn-outline btn-sm" style="width: 100%;">Chỉnh sửa hồ sơ</a>
                    {% else %}
                        <a href="#" class="btn btn-primary btn-sm" style="width: 100%;">Nhắn tin</a>
                    {% endif %}
                    
                    <div class="profile-stats">
                         <div class="stat-item"><div class="value">{{ trips_joined.count }}</div><div class="label">Chuyến đi</div></div>
                         <div class="stat-item"><div class="value">{{ badges_earned.count }}</div><div class="label">Huy hiệu</div></div>
                         <div class="stat-item"><div class="value">{{ posts_created.count }}</div><div class="label">Bài viết</div></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CỘT BÊN PHẢI: CÁC HOẠT ĐỘNG -->
        <section class="profile-main">
            <div class="card"><div class="card-body">
                <nav class="profile-tabs">
                    <div class="tab-link active" data-tab="cv">Năng lực & Sở thích</div>
                    <div class="tab-link" data-tab="trips">Lịch sử Chuyến đi</div>
                    <div class="tab-link" data-tab="posts">Bài viết đã đăng</div>
                    <div class="tab-link" data-tab="badges">Huy hiệu & Thành tích</div>
                </nav>

                <div id="cv" class="tab-content active">
                    <h4 class="section-title">Thiết bị cá nhân</h4>
                    {% if personal_equipment %}<div class="equipment-list">
                        {% for item in personal_equipment %}
                        <div class="item">
                            <div class="item-name">{{ item.vat_dung.ten }} {% if item.so_luong > 1 %}<span class="badge badge-primary">x{{ item.so_luong }}</span>{% endif %}</div>
                            <div class="item-note">{{ item.ghi_chu }}</div>
                        </div>
                        {% endfor %}
                    </div>{% else %}<p class="text-muted">Chưa cập nhật danh sách thiết bị.</p>{% endif %}
                    <hr class="my-4"><h4 class="section-title">Sở thích</h4>
                    {% if user_interests %}<div class="interests-list">
                        {% for interest in user_interests %}<span class="badge badge-success">{{ interest.the.ten }}</span>{% endfor %}
                    </div>{% else %}<p class="text-muted">Chưa cập nhật sở thích.</p>{% endif %}
                </div>
                <div id="trips" class="tab-content"><div class="activity-list">
                    {% for membership in trips_joined %}<div class="activity-item">
                        <h5 class="card-title mb-1"><a href="#">{{ membership.chuyen_di.ten_chuyen_di }}</a></h5>
                        <p class="text-sm text-muted mb-0">Khởi hành: {{ membership.chuyen_di.ngay_bat_dau|date:"d/m/Y" }} - Cung đường: {{ membership.chuyen_di.cung_duong.ten }}</p>
                    </div>{% empty %}<p class="text-muted text-center py-5">Chưa tham gia chuyến đi nào.</p>{% endfor %}
                </div></div>
                <div id="posts" class="tab-content"><div class="activity-list">
                    {% for post in posts_created %}<div class="activity-item">
                        <h5 class="card-title mb-1"><a href="#">{{ post.tieu_de }}</a></h5>
                        <p class="text-sm text-muted mb-0">Đã đăng vào {{ post.ngay_dang|date:"d/m/Y" }}</p>
                    </div>{% empty %}<p class="text-muted text-center py-5">Chưa đăng bài viết nào.</p>{% endfor %}
                </div></div>
                <div id="badges" class="tab-content">
                    <div class="badge-grid">
                        {% for user_badge in badges_earned %}<div class="badge-item">
                            <img src="{{ user_badge.huy_hieu.anh_huy_hieu|default:'/static/images/default_badge.png' }}" alt="{{ user_badge.huy_hieu.ten }}">
                            <div class="name">{{ user_badge.huy_hieu.ten }}</div>
                            <div class="date">{{ user_badge.ngay_dat_duoc|date:"d/m/Y" }}</div>
                        </div>{% empty %}<p class="text-muted text-center py-5" style="grid-column: 1 / -1;">Chưa đạt được huy hiệu nào.</p>{% endfor %}
                    </div>
                    <hr class="my-4">
                    <h5 class="text-center">Điểm thưởng: <span class="text-primary font-bold text-xl">{{ profile_user.taikhoanhoso.diem_thuong }}</span></h5>
                </div>
            </div></div>
        </section>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', () => {
            const tabId = link.getAttribute('data-tab');
            document.querySelectorAll('.tab-link').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(item => item.classList.remove('active'));
            link.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
});
</script>
{% endblock %}