{% extends "base.html" %}
{% load static %}

{% block title %}Đăng Ký - TrekViet{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auth_forms.css' %}">
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-container">
        <div class="auth-form">
            <div class="auth-logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M14 6l-4.22 5.63 1.25 1.67L14 9.33 19 16h-8.46l-4.01-5.37L1 18h22L14 6zM5 16l1.52-2.03L8.04 16H5z" />
                </svg>
            </div>

            <h2>Chào mừng, nhà thám hiểm mới!</h2>
            <p class="auth-subtitle">Đăng ký để gia nhập TrekViet và bắt đầu hành trình khám phá.</p>

            {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <form method="post" novalidate id="registerForm">
                {% csrf_token %}

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}</label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}<div class="form-field-error">{{
                            form.last_name.errors.as_text|striptags }}</div>{% endif %}
                    </div>
                    <div class="form-group half-width">
                        <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}</label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}<div class="form-field-error">{{
                            form.first_name.errors.as_text|striptags }}</div>{% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="{{ form.ngay_sinh.id_for_label }}">{{ form.ngay_sinh.label }}</label>
                        {{ form.ngay_sinh }}
                        {% if form.ngay_sinh.errors %}<div class="form-field-error">{{
                            form.ngay_sinh.errors.as_text|striptags }}</div>{% endif %}
                    </div>
                    <div class="form-group half-width">
                        <label>{{ form.gioi_tinh.label }}</label>
                        <div class="gender-group-wrapper" tabindex="0">
                            {% for radio in form.gioi_tinh %}
                            <div class="gender-item">
                                {{ radio.tag }}
                                <label for="{{ radio.id_for_label }}"
                                    class="gender-label-{{ radio.choice_value|lower }}">
                                    {{ radio.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.gioi_tinh.errors %}<div class="form-field-error">{{
                            form.gioi_tinh.errors.as_text|striptags }}</div>{% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
                    <div class="input-wrapper">
                        {{ form.username }}
                        <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                    </div>
                    {% if form.username.errors %}<div class="form-field-error">{{ form.username.errors.as_text|striptags
                        }}</div>{% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                    <div class="input-wrapper">
                        {{ form.email }}
                        <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                        </svg>
                    </div>
                    {% if form.email.errors %}<div class="form-field-error">{{ form.email.errors.as_text|striptags }}
                    </div>{% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.sdt.id_for_label }}">{{ form.sdt.label }}</label>
                    <div class="input-wrapper">
                        {{ form.sdt }}
                        <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" />
                        </svg>
                    </div>
                    {% if form.sdt.errors %}<div class="form-field-error">{{ form.sdt.errors.as_text|striptags }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.password1.id_for_label }}">Mật khẩu</label>
                    <div class="input-wrapper">
                        {{ form.password1 }}
                        <!-- Nút này bây giờ sẽ gọi hàm togglePassword trong scope của DOMContentLoaded -->
                        <button type="button" class="password-toggle" id="password-toggle-button"></button>
                    </div>

                    <div id="password-requirements" class="password-reqs">
                        <p>Mật khẩu của bạn cần đáp ứng:</p>
                        <ul>
                            <li id="req-length"><span></span>Ít nhất 8 ký tự</li>
                            <li id="req-number"><span></span>Ít nhất một chữ số</li>
                            <li id="req-uppercase"><span></span>Ít nhất một chữ cái viết hoa</li>
                            <li id="req-lowercase"><span></span>Ít nhất một chữ cái viết thường</li>
                        </ul>
                    </div>
                    {% if form.password1.errors %}<div class="form-field-error">{{ form.password1.errors.as_ul }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.password2.id_for_label }}">Xác nhận mật khẩu</label>
                    <div class="input-wrapper">
                        {{ form.password2 }}
                    </div>
                    {% if form.password2.errors %}<div class="form-field-error">{{
                        form.password2.errors.as_text|striptags }}</div>{% endif %}
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">
                    Tạo Tài Khoản
                </button>
            </form>

            <p class="auth-switch">Đã có tài khoản? <a href="{% url 'accounts:dang-nhap' %}">Đăng nhập ngay</a></p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- 1. XỬ LÝ PASSWORD REQUIREMENTS & TOGGLE VISIBILITY ---
        const passwordInput = document.getElementById('{{ form.password1.id_for_label }}');
        const requirementsBox = document.getElementById('password-requirements');
        const passwordToggleButton = document.getElementById('password-toggle-button');

        if (passwordInput && requirementsBox) {
            const requirements = {
                length: document.getElementById('req-length'),
                number: document.getElementById('req-number'),
                uppercase: document.getElementById('req-uppercase'),
                lowercase: document.getElementById('req-lowercase')
            };

            passwordInput.addEventListener('focus', () => { requirementsBox.style.display = 'block'; });
            passwordInput.addEventListener('blur', () => { requirementsBox.style.display = 'none'; });
            passwordInput.addEventListener('input', () => {
                const value = passwordInput.value;
                requirements.length.classList.toggle('valid', value.length >= 8);
                requirements.number.classList.toggle('valid', /\d/.test(value));
                requirements.uppercase.classList.toggle('valid', /[A-Z]/.test(value));
                requirements.lowercase.classList.toggle('valid', /[a-z]/.test(value));
            });
        }

        // --- HÀM TOGGLE PASSWORD VISIBILITY ---
        function togglePassword() {
            const eyeOn = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
            const eyeOff = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggleButton.innerHTML = eyeOff;
            } else {
                passwordInput.type = 'password';
                passwordToggleButton.innerHTML = eyeOn;
            }
        }

        if (passwordToggleButton) {
            // Đặt icon mắt ban đầu
            passwordToggleButton.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
            // Gán sự kiện click
            passwordToggleButton.addEventListener('click', togglePassword);
        }


        // --- 2. XỬ LÝ GENDER SELECTION (PHIÊN BẢN JS ĐÁNG TIN CẬY) ---
        const genderRadios = document.querySelectorAll('.gender-item input[name="{{ form.gioi_tinh.name }}"]');

        function updateGenderSelection() {
            genderRadios.forEach(radio => {
                const label = document.querySelector(`label[for="${radio.id}"]`);
                if (label) {
                    label.classList.toggle('selected', radio.checked);
                }
            });
        }

        genderRadios.forEach(radio => {
            radio.addEventListener('change', updateGenderSelection);
        });
        updateGenderSelection(); // Chạy lần đầu


        // --- 3. XỬ LÝ VÔ HIỆU HÓA NÚT SUBMIT ---
        document.getElementById('registerForm').addEventListener('submit', function (e) {
            document.getElementById('submitBtn').disabled = true;
        });
    });
</script>
{% endblock %}