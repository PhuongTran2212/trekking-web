{% extends "base.html" %}
{% load static %}

{% block title %}Cài đặt tài khoản{% endblock %}

{% block extra_css %}
<!-- Link CSS cho thư viện Tagify -->
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

<style>
    .update-container { max-width: 800px; margin: 2rem auto; }
    /* Style cho các Tab */
    .nav-tabs { border-bottom: 2px solid var(--gray-200); }
    .nav-tabs .nav-link { 
        color: var(--gray-500); 
        cursor: pointer;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }
    .nav-tabs .nav-link.active { 
        color: var(--primary-dark); 
        border-color: var(--primary-dark); 
        font-weight: 600; 
        background-color: transparent;
    }
    .tab-content { padding-top: var(--spacing-lg); }

    /* Style cho phần upload ảnh đại diện */
    .avatar-upload-wrapper { display: flex; align-items: center; gap: var(--spacing-lg); }
    .avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gray-200); }
    
    /* Style cho thư viện Tagify */
    .tagify { --tags-border-color: var(--gray-300); border-radius: var(--radius-md); }
    .tagify:hover { --tags-border-color: var(--primary-dark); }
    .tagify__tag { --tag-bg: var(--primary-dark); --tag-text-color: white; }
    .tagify__input { margin: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="container update-container">
    <h1 class="h2 mb-4">Cài đặt tài khoản & Hồ sơ</h1>

    <!-- Thanh điều hướng Tab -->
    <ul class="nav nav-tabs" id="profileTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-pane" type="button" role="tab">Thông tin chung</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="interests-tab" data-bs-toggle="tab" data-bs-target="#interests-pane" type="button" role="tab">Sở thích</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="equipment-tab" data-bs-toggle="tab" data-bs-target="#equipment-pane" type="button" role="tab">Kho thiết bị</button>
        </li>
    </ul>

    <!-- Nội dung các Tab -->
    <div class="tab-content" id="profileTabContent">
        <!-- TAB 1: THÔNG TIN CHUNG -->
        <div class="tab-pane fade show active" id="info-pane" role="tabpanel">
            <div class="card border-0"><div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="basic_info">
                    
                    <div class="form-group mb-4">
                        <label class="form-label fw-bold">Ảnh đại diện</label>
                        <div class="avatar-upload-wrapper">
                            <img src="{{ user.taikhoanhoso.avatar_url }}" alt="Avatar hiện tại" class="avatar-preview" id="avatarPreview">
                            <div>
                                {{ profile_form.anh_dai_dien }}
                                <small class="form-text text-muted">Chọn ảnh mới để thay thế.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group"><label class="form-label fw-bold">Họ</label>{{ user_form.last_name }}</div>
                    <div class="form-group"><label class="form-label fw-bold">Tên</label>{{ user_form.first_name }}</div>
                    <div class="form-group"><label class="form-label fw-bold">Số điện thoại</label>{{ profile_form.sdt }}</div>
                    <div class="form-group"><label class="form-label fw-bold">{{ profile_form.tinh_thanh.label }}</label>{{ profile_form.tinh_thanh }}</div>
                    <div class="form-group"><label class="form-label fw-bold">Giới thiệu / Kinh nghiệm</label>{{ profile_form.gioi_thieu }}</div>
                    <button type="submit" class="btn btn-primary mt-3">Lưu thông tin</button>
                </form>
            </div></div>
        </div>

        <!-- TAB 2: SỞ THÍCH -->
        <div class="tab-pane fade" id="interests-pane" role="tabpanel">
            <div class="card border-0"><div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="interests">
                    <div class="form-group">
                        <label class="form-label fw-bold">{{ interests_form.interests.label }}</label>
                        {{ interests_form.interests }}
                        <small class="form-text text-muted">Gõ để thêm sở thích mới hoặc chọn từ danh sách gợi ý.</small>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Lưu sở thích</button>
                </form>
            </div></div>
        </div>

        <!-- TAB 3: KHO THIẾT BỊ -->
        <div class="tab-pane fade" id="equipment-pane" role="tabpanel">
            <div class="card border-0"><div class="card-body">
                {% include 'accounts/partials/_equipment_manager.html' %}
            </div></div>
        </div>
    </div>
</div>

<!-- Script cho Tagify và Preview ảnh -->
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- Logic cho Preview ảnh ---
    const avatarInput = document.querySelector('input[type=file][name=anh_dai_dien]');
    const avatarPreview = document.getElementById("avatarPreview");
    if (avatarInput) {
        avatarInput.addEventListener("change", function(event) {
            if (event.target.files && event.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => avatarPreview.src = e.target.result;
                reader.readAsDataURL(event.target.files[0]);
            }
        });
    }

    // --- Logic cho Tagify (Sở thích) ---
    const input = document.querySelector('input[name=interests]');
    if(input) {
        const whitelist = JSON.parse('{{ all_tags_whitelist|escapejs }}');
        new Tagify(input, {
            whitelist: whitelist,
            maxTags: 10,
            dropdown: { maxItems: 20, classname: "tags-look", enabled: 0, closeOnSelect: false }
        });
    }
});
</script>

{% include "partials/_form_field_class_filter.html" %}
{% endblock %}