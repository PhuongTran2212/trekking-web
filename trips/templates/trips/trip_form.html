{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    :root {
        --primary-color: #2c7744;
        --primary-light: #e6f4ea;
        --primary-dark: #1e5631;
        --accent-color: #f59e0b;
        --bg-body: #f8fafc;
        --text-dark: #1e293b;
        --text-gray: #64748b;
        --border-color: #e2e8f0;
        --danger: #ef4444;
        --success: #22c55e;
    }

    body {
        background-color: var(--bg-body);
        color: var(--text-dark);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .main-wrapper {
        padding: 1.5rem 0 120px;
    }

    /* Optimized main layout grid with better spacing and balance */
    .main-content-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    /* === HEADER SIMPLE === */
    .page-header {
        margin-bottom: 1.5rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .breadcrumb-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary-light);
        border-radius: 50px;
        color: var(--primary-color);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .btn-back:hover {
        background: var(--primary-color);
        color: white;
    }

    .badge-route {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-light);
        color: var(--primary-color);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .page-title {
        font-weight: 800;
        font-size: 1.75rem;
        color: var(--text-dark);
        margin: 0;
    }

    .btn-view-page {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--border-color);
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .btn-view-page:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* === ALERT === */
    .alert-modern {
        background: #fef2f2;
        border: none;
        border-left: 4px solid var(--danger);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        grid-column: 1 / -1;
    }

    .alert-icon {
        width: 40px;
        height: 40px;
        background: var(--danger);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    /* === CARDS === */
    .card-modern {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .card-modern:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border-color: var(--border-color);
    }

    .card-header-modern {
        background: linear-gradient(135deg, #fafafa 0%, #f3f4f6 100%);
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header-title {
        font-size: 0.95rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-dark);
        margin: 0;
    }

    .step-icon {
        width: 36px;
        height: 36px;
        background: var(--primary-color);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .step-icon.accent {
        background: var(--accent-color);
    }

    .step-icon.dark {
        background: #374151;
    }

    .card-body-modern {
        padding: 1.5rem;
    }

    /* === FORM INPUTS === */
    .form-label-modern {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-gray);
        margin-bottom: 0.75rem;
    }

    .form-control, .form-select {
        border-radius: 10px;
        border: 1px solid var(--border-color);
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background-color: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(44, 119, 68, 0.1);
        outline: none;
    }

    .form-floating > .form-control {
        padding: 1.25rem 1rem 0.5rem;
    }

    .form-floating > label {
        padding: 0.75rem 1rem;
        color: var(--text-gray);
        font-size: 0.9rem;
    }

    .input-group .input-group-text {
        background: #fafafa;
        border: 1px solid var(--border-color);
        color: var(--text-gray);
        font-size: 0.9rem;
    }

    .form-group-modern {
        margin-bottom: 1.5rem;
    }

    .form-text {
        font-size: 0.8rem;
        color: var(--text-gray);
        margin-top: 0.5rem;
    }

    /* === TIMELINE DRAGGABLE === */
    .timeline-container {
        position: relative;
        padding-left: 24px;
    }

    .timeline-container::before {
        content: '';
        position: absolute;
        top: 20px;
        bottom: 20px;
        left: 11px;
        width: 2px;
        background: linear-gradient(to bottom, var(--primary-color), var(--border-color));
        border-radius: 2px;
    }

    .timeline-item {
        position: relative;
        padding-left: 32px;
        margin-bottom: 1.25rem;
        cursor: grab;
        transition: transform 0.2s ease;
    }

    .timeline-item:active {
        cursor: grabbing;
    }

    .timeline-item.sortable-ghost {
        opacity: 0.4;
    }

    .timeline-item.sortable-drag {
        opacity: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 100;
    }

    .timeline-dot {
        position: absolute;
        left: 0;
        top: 16px;
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        border-radius: 50%;
        z-index: 1;
        box-shadow: 0 0 0 4px white;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
    }

    .timeline-card {
        background: #fafafa;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        position: relative;
        transition: all 0.2s ease;
    }

    .timeline-card:hover {
        background: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .btn-delete-row {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: #fee2e2;
        color: var(--danger);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        cursor: pointer;
        z-index: 10;
    }

    .btn-delete-row:hover {
        background: var(--danger);
        color: white;
        transform: scale(1.1);
    }

    .timeline-fields {
        padding-right: 40px;
    }

    .btn-add-timeline {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary-light);
        color: var(--primary-color);
        border: none;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-add-timeline:hover {
        background: var(--primary-color);
        color: white;
    }

    /* === UPLOAD ZONE === */
    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        background: #fafafa;
        padding: 2rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .upload-zone:hover {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .upload-icon {
        font-size: 2.5rem;
        color: var(--text-gray);
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }

    .upload-zone:hover .upload-icon {
        color: var(--primary-color);
        transform: scale(1.1);
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-top: 1rem;
    }

    .preview-img {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease;
    }

    .preview-img:hover {
        transform: scale(1.05);
    }

    /* === SETTINGS === */
    .setting-box {
        background: #fafafa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .setting-box:hover {
        background: white;
        border-color: var(--primary-color);
    }

    .form-switch-modern {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: #fafafa;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .form-switch-modern:hover {
        background: white;
        border-color: var(--primary-color);
    }

    .form-switch-modern .form-check-input {
        width: 44px;
        height: 24px;
        cursor: pointer;
    }

    .form-switch-modern .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* === STICKY FOOTER === */
    .sticky-footer {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 1200px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem 1.5rem;
        border-radius: 100px;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
    }

    .footer-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-gray);
        font-size: 0.875rem;
    }

    .footer-info i {
        color: var(--success);
    }

    .btn-cancel {
        padding: 0.75rem 1.75rem;
        background: #f1f5f9;
        color: var(--text-dark);
        border: none;
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-cancel:hover {
        background: #e2e8f0;
        color: var(--text-dark);
    }

    .btn-save {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.75rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50px;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(44, 119, 68, 0.3);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-save:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(44, 119, 68, 0.4);
    }

    /* === SELECT2 === */
    .select2-container--bootstrap-5 .select2-selection {
        border-radius: 10px !important;
        border: 1px solid var(--border-color) !important;
        min-height: 44px !important;
    }

    .select2-container--bootstrap-5.select2-container--focus .select2-selection {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 3px rgba(44, 119, 68, 0.1) !important;
    }

    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background: var(--primary-light) !important;
        border: none !important;
        border-radius: 50px !important;
        color: var(--primary-color) !important;
        font-weight: 600 !important;
    }

    /* Enhanced responsive design for 2-column layout */
    @media (max-width: 1200px) {
        .main-content-wrapper {
            gap: 1.5rem;
        }
    }

    @media (max-width: 992px) {
        .main-content-wrapper {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .alert-modern {
            grid-column: 1;
        }
    }

    @media (max-width: 768px) {
        .main-wrapper {
            padding: 1rem 0 120px;
        }

        .main-content-wrapper {
            gap: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .sticky-footer {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            border-radius: 20px;
        }

        .footer-info {
            display: none;
        }

        .timeline-fields {
            padding-right: 0;
        }

        .row g-3 > div {
            min-width: 0;
        }
    }

    @media (max-width: 576px) {
        .page-header {
            padding: 0.75rem 0;
        }

        .breadcrumb-nav {
            gap: 0.5rem;
        }

        .btn-back, .badge-route {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .card-body-modern {
            padding: 1rem;
        }

        .timeline-item {
            padding-left: 24px;
            margin-bottom: 1rem;
        }

        .preview-grid {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container main-wrapper">

    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div>
                <div class="breadcrumb-nav">
                    <a href="{% url 'treks:cung_duong_list' %}" class="btn-back">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                    <span class="badge-route">
                        <i class="fas fa-map-signs"></i> {{ object.cung_duong.ten|default:cung_duong.ten }}
                    </span>
                </div>
                <h1 class="page-title">{{ page_title }}</h1>
            </div>
            {% if is_edit %}
            <a href="{{ object.get_absolute_url }}" class="btn-view-page mt-3 mt-md-0">
                <i class="far fa-eye"></i> Xem trang hiển thị
            </a>
            {% endif %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="tripForm">
        {% csrf_token %}

        {% if form.errors or timeline_formset.errors %}
        <div class="alert-modern">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>
                <h6 class="fw-bold mb-1" style="color: var(--danger);">Vui lòng kiểm tra lại thông tin!</h6>
                <p class="text-muted small mb-0">Có vẻ như bạn đã bỏ sót trường bắt buộc hoặc nhập sai định dạng.</p>
                <div class="small mt-1" style="color: var(--danger);">
                    {{ form.non_field_errors }}
                    {{ timeline_formset.non_form_errors }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Two-column layout wrapper using CSS Grid for optimal balance -->
        <div class="main-content-wrapper">

            <!-- LEFT COLUMN: Thông tin chi tiết + Timeline + Upload ảnh -->
            <div class="col-left">

                <!-- Thông tin chung -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="header-title">
                            <span class="step-icon"><i class="fas fa-info"></i></span>
                            Thông tin chi tiết
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="form-group-modern">
                             <label class="form-label-modern">
                                   <i class="fa-solid fa-file-signature"></i> Tên chuyến đi
                                </label>
                            <div class="form-floating">
                                {{ form.ten_chuyen_di }}
                            </div>
                            {% if form.ten_chuyen_di.errors %}
                            <div class="text-danger small mt-1">{{ form.ten_chuyen_di.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label-modern">
                                    <i class="fas fa-map-marker-alt text-danger me-1"></i> Điểm tập trung
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class=""></i></span>
                                    {{ form.dia_diem_tap_trung }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">
                                    <i class="fas fa-tags me-1"></i> Tags (Từ khóa)
                                </label>
                                {{ form.tags }}
                            </div>
                        </div>

                        <div class="form-group-modern mt-3">
                            <label class="form-label-modern">
                                <i class="fas fa-align-left me-1"></i> Mô tả & Kế hoạch
                            </label>
                            {{ form.mo_ta }}
                            <div class="form-text">
                                <i class="fas fa-lightbulb text-warning me-1"></i>
                                Mô tả càng chi tiết càng thu hút nhiều thành viên tham gia hơn.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Draggable -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="header-title">
                            <span class="step-icon"><i class="fas fa-route"></i></span>
                            Lịch trình chi tiết
                        </div>
                        <button type="button" id="add-timeline-btn" class="btn-add-timeline">
                            <i class="fas fa-plus"></i> Thêm mốc
                        </button>
                    </div>
                    <div class="card-body-modern">
                        {{ timeline_formset.management_form }}

                        <div id="timeline-container" class="timeline-container">
                            {% for subform in timeline_formset %}
                            <div class="timeline-item timeline-row" data-index="{{ forloop.counter }}">
                                <div class="timeline-dot">{{ forloop.counter }}</div>
                                <div class="timeline-card">
                                    {% for hidden in subform.hidden_fields %}{{ hidden }}{% endfor %}
                                    
                                    {% if timeline_formset.can_delete %}
                                    <div class="d-none">{{ subform.DELETE }}</div>
                                    {% endif %}
                                    <button type="button" class="btn-delete-row btn-delete" title="Xóa mốc này">
                                        <i class="fas fa-times"></i>
                                    </button>

                                    <div class="timeline-fields">
                                        <div class="row g-2 align-items-center mb-2">
                                            <div class="col-md-3 col-6">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light text-muted fw-bold">Ngày</span>
                                                    {{ subform.ngay }}
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light"><i class="far fa-clock"></i></span>
                                                    {{ subform.thoi_gian }}
                                                </div>
                                            </div>
                                            <div class="col-md-6 col-12">
                                                {{ subform.hoat_dong }}
                                            </div>
                                        </div>
                                        <div>
                                            {{ subform.mo_ta_chi_tiet }}
                                        </div>
                                    </div>

                                    {% if subform.errors %}
                                    <div class="text-danger small mt-1">{{ subform.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Empty form template -->
                        <div id="empty-form-template" class="d-none">
                            <div class="timeline-item timeline-row">
                                <div class="timeline-dot"></div>
                                <div class="timeline-card">
                                    {% for hidden in timeline_formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    
                                    <div class="d-none">{{ timeline_formset.empty_form.DELETE }}</div>
                                    <button type="button" class="btn-delete-row btn-delete">
                                        <i class="fas fa-times"></i>
                                    </button>

                                    <div class="timeline-fields">
                                        <div class="row g-2 align-items-center mb-2">
                                            <div class="col-md-3 col-6">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light text-muted fw-bold">Ngày</span>
                                                    {{ timeline_formset.empty_form.ngay }}
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light"><i class="far fa-clock"></i></span>
                                                    {{ timeline_formset.empty_form.thoi_gian }}
                                                </div>
                                            </div>
                                            <div class="col-md-6 col-12">
                                                {{ timeline_formset.empty_form.hoat_dong }}
                                            </div>
                                        </div>
                                        <div>
                                            {{ timeline_formset.empty_form.mo_ta_chi_tiet }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload ảnh -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="header-title">
                            <span class="step-icon" style="background: #8b5cf6;"><i class="fas fa-images"></i></span>
                            Thư viện ảnh
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="upload-zone" onclick="document.getElementById('media-input').click()">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <div class="fw-bold text-dark">Kéo thả hoặc bấm để tải ảnh</div>
                            <div class="small text-muted">JPG, PNG tối đa 10MB</div>
                            <input type="file" id="media-input" name="trip_media_files" multiple hidden accept="image/*">
                        </div>
                        <div id="upload-preview" class="preview-grid"></div>

                        {% if object and object.media.exists %}
                        <div class="mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted fw-bold">
                                    <i class="fas fa-image me-1"></i> Ảnh đã có
                                </small>
                                <span class="badge" style="background: var(--primary-light); color: var(--primary-color);">
                                    {{ object.media.count }}
                                </span>
                            </div>
                            <div class="preview-grid">
                                {% for m in object.media.all|slice:":6" %}
                                <img src="{{ m.file.url }}" class="preview-img">
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Kế hoạch + Cài đặt (sticky on desktop) -->
            <div class="col-right">

                <!-- Kế hoạch -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="header-title">
                            <span class="step-icon accent"><i class="far fa-calendar-alt"></i></span>
                            Kế hoạch
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label-modern">
                                    <i class="fas fa-play text-success me-1"></i> Ngày bắt đầu
                                </label>
                                {{ form.ngay_bat_dau }}
                            </div>
                            <div class="col-6">
                                <label class="form-label-modern">
                                    <i class="fas fa-flag-checkered text-danger me-1"></i> Ngày kết thúc
                                </label>
                                {{ form.ngay_ket_thuc }}
                            </div>
                        </div>

                        <div class="setting-box mt-3">
                            <label class="form-label-modern">
                                <i class="fas fa-coins text-warning me-1"></i> Chi phí dự kiến (VND)
                            </label>
                            <div class="input-group">
                                {{ form.chi_phi_uoc_tinh }}
                                <span class="input-group-text fw-bold" style="color: var(--success);"></span>
                            </div>
                        </div>

                        <div class="form-group-modern">
                            <label class="form-label-modern">
                                <i class="fas fa-users me-1"></i> Số thành viên tối đa
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"></span>
                                {{ form.so_luong_toi_da }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cài đặt -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="header-title">
                            <span class="step-icon dark"><i class="fas fa-sliders"></i></span>
                            Cài đặt
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="form-group-modern">
                            <label class="form-label-modern">
                                <i class="fas fa-lock me-1"></i> Quyền riêng tư
                            </label>
                            {{ form.che_do_rieng_tu }}
                        </div>

                        <div class="form-switch-modern form-check form-switch">
                            <label class="form-check-label fw-bold" for="{{ form.yeu_cau_ly_do.id_for_label }}">
                                <i class="fas fa-user-check me-2" style="color: #3b82f6;"></i>
                                Duyệt thành viên
                            </label>
                            {{ form.yeu_cau_ly_do }}
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sticky Footer -->
        <div class="sticky-footer">
            <div class="footer-info d-none d-md-flex">
                <i class="fas fa-check-circle"></i>
                <span class="fw-medium">Mọi thay đổi sẽ được lưu</span>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'trips:trip_hub' %}" class="btn-cancel">Hủy</a>
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Lưu Chuyến đi
                </button>
            </div>
        </div>

    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    $(document).ready(function () {
        $('#id_tags').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: "Chọn từ khóa..."
        });

        $('#tripForm input, #tripForm select, #tripForm textarea').addClass('form-control');
        $('#tripForm select').addClass('form-select');
        $('#tripForm input[type="checkbox"]').removeClass('form-control').addClass('form-check-input');

        $('input[name$="hoat_dong"]').attr('placeholder', 'VD: Check-in đỉnh núi, Ăn trưa...');
        $('textarea[name$="mo_ta_chi_tiet"]').attr('placeholder', 'Mô tả chi tiết hoạt động...');
        $('textarea[name$="mo_ta_chi_tiet"]').attr('rows', '2');

        const container = $('#timeline-container');
        const totalForms = $('#id_timeline-TOTAL_FORMS');
        const template = $('#empty-form-template').html();

        function updateTimelineNumbers() {
            container.find('.timeline-row:visible').each(function(index) {
                $(this).find('.timeline-dot').text(index + 1);
                $(this).attr('data-index', index + 1);
            });
        }

        $('#add-timeline-btn').click(function () {
            let idx = parseInt(totalForms.val());
            let newRowHtml = template.replace(/__prefix__/g, idx);
            container.append(newRowHtml);
            totalForms.val(idx + 1);

            let newRow = container.children().last();
            newRow.find('input, select, textarea').addClass('form-control');
            newRow.find('input[name$="hoat_dong"]').attr('placeholder', 'VD: Hoạt động tiếp theo...');
            newRow.find('textarea[name$="mo_ta_chi_tiet"]').attr('rows', '2');
            
            updateTimelineNumbers();
            newRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        container.on('click', '.btn-delete', function () {
            const row = $(this).closest('.timeline-row');
            const delInput = row.find('input[name$="-DELETE"]');

            if (delInput.length > 0) {
                delInput.prop('checked', true);
                row.fadeOut(300, function() {
                    updateTimelineNumbers();
                });
            } else {
                row.slideUp(300, function() {
                    $(this).remove();
                    updateTimelineNumbers();
                });
            }
        });

        new Sortable(document.getElementById('timeline-container'), {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            handle: '.timeline-card',
            onEnd: function() {
                updateTimelineNumbers();
            }
        });

        $('#media-input').change(function () {
            const preview = $('#upload-preview');
            preview.empty();
            if (this.files) {
                Array.from(this.files).forEach((f, index) => {
                    if (f.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = $(`<img src="${e.target.result}" class="preview-img" style="opacity: 0; transform: scale(0.9);">`);
                            preview.append(img);
                            setTimeout(() => {
                                img.css({
                                    'opacity': '1',
                                    'transform': 'scale(1)',
                                    'transition': 'all 0.2s ease'
                                });
                            }, index * 80);
                        }
                        reader.readAsDataURL(f);
                    }
                });
            }
        });

        if ($('.alert-modern').length) {
            $('html, body').animate({
                scrollTop: $('.alert-modern').offset().top - 100
            }, 400);
        }

        updateTimelineNumbers();
    });
</script>
{% endblock %}
