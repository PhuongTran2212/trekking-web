{% load humanize %}

<a href="{% if trip.che_do_rieng_tu == 'RIENG_TU' and trip.nguoi_to_chuc != user and trip.user_status != 'DA_THAM_GIA' %}javascript:void(0){% else %}{{ trip.get_absolute_url }}{% endif %}" 
   class="trip-card {% if trip.che_do_rieng_tu == 'RIENG_TU' and trip.nguoi_to_chuc != user and trip.user_status != 'DA_THAM_GIA' %}js-locked-trip{% endif %}"
   {% if trip.che_do_rieng_tu == 'RIENG_TU' and trip.nguoi_to_chuc != user and trip.user_status != 'DA_THAM_GIA' %}data-bs-toggle="modal" data-bs-target="#tripCodeModal"data-trip-id="{{ trip.pk }}" {% endif %}>
   
    <div class="card-img-wrapper">
        <img src="{{ trip.cover_url }}" class="card-img" alt="{{ trip.ten_chuyen_di }}" loading="lazy">
        
        {# --- 1. BADGE RIÊNG TƯ / CÔNG KHAI (Góc Trái Trên) --- #}
        <span class="badge-privacy {% if trip.che_do_rieng_tu == 'RIENG_TU' %}bg-private{% else %}bg-public{% endif %}">
            {% if trip.che_do_rieng_tu == 'RIENG_TU' %}
                <i class="fas fa-lock"></i> Riêng tư
            {% else %}
                <i class="fas fa-globe-asia"></i> Công khai
            {% endif %}
        </span>

        {# --- 2. TRẠNG THÁI NGƯỜI DÙNG (Nằm ngay dưới badge privacy) --- #}
        {% if user.is_authenticated %}
            {% if trip.nguoi_to_chuc == user %}
                <span class="badge-user-status bg-warning text-dark"><i class="fas fa-crown"></i> Trưởng đoàn</span>
            {% elif trip.user_status == 'DA_THAM_GIA' %}
                <span class="badge-user-status bg-success"><i class="fas fa-check-circle"></i> Đã tham gia</span>
            {% elif trip.user_status == 'DA_GUI_YEU_CAU' %}
                <span class="badge-user-status bg-info"><i class="fas fa-clock"></i> Chờ duyệt</span>
            {% elif trip.user_status == 'BI_TU_CHOI' %}
                <span class="badge-user-status bg-danger"><i class="fas fa-ban"></i> Bị từ chối</span>
            {% endif %}
        {% endif %}

        {# --- 3. TRẠNG THÁI TRIP (Góc Phải Trên) --- #}
        <span class="badge rounded-pill shadow-sm text-white fw-bold trip-status-badge"
              data-color="{{ trip.status_color|default_if_none:'#10b981'|escape }}"
              style="position: absolute; top: 12px; right: 12px; z-index: 10; backdrop-filter: blur(2px);">
            {{ trip.status_name|default:"Sắp diễn ra" }}
        </span>
        
        {# --- 4. ĐỘ KHÓ (Góc Trái Dưới) --- #}
        {% if trip.cung_duong.do_kho %}
        <span class="badge-level">
            <i class="fas fa-mountain"></i> {{ trip.cung_duong.do_kho.ten }}
        </span>
        {% endif %}

        {# --- 5. GIÁ TIỀN (Góc Phải Dưới) --- #}
        <span class="badge-price">
            {% if trip.chi_phi_uoc_tinh > 0 %}
                {{ trip.chi_phi_uoc_tinh|intcomma }}<small>VND</small>
            {% else %}
                Miễn phí
            {% endif %}
        </span>
        
        {# --- 6. OVERLAY Ổ KHÓA (Khi bị khóa) --- #}
        {% if trip.che_do_rieng_tu == 'RIENG_TU' and trip.nguoi_to_chuc != user and trip.user_status != 'DA_THAM_GIA' %}
        <div class="locked-overlay">
            <i class="fas fa-lock mb-1"></i>
            <span>Nhập mã</span>
        </div>
        {% endif %}
    </div>

    <div class="card-body">
        <h3 class="card-title" title="{{ trip.ten_chuyen_di }}">
            {{ trip.ten_chuyen_di }}
        </h3>
        
        {# Cảnh báo khóa #}
        {% if trip.che_do_rieng_tu == 'RIENG_TU' and trip.nguoi_to_chuc != user and trip.user_status != 'DA_THAM_GIA' %}
        <div class="text-warning small mb-2 fw-bold d-flex align-items-center">
            <i class="fas fa-key me-2"></i> Yêu cầu mã tham gia
        </div>
        {% endif %}

        <div class="card-location">
            <i class="fas fa-map-marker-alt text-danger"></i>
            <span>{{ trip.cung_duong.tinh_thanh.ten }} • {{ trip.cung_duong.ten }}</span>
        </div>

        <div class="card-meta">
            <div class="meta-item">
                <i class="far fa-calendar-alt text-primary"></i>
                {{ trip.ngay_bat_dau|date:"d/m/Y" }}
            </div>
            
            <div class="meta-item">
                <i class="far fa-clock text-warning"></i>
                {{ trip.thoi_gian_display }}
            </div>
        </div>

        {% if trip.tags.all %}
        <div class="card-tags">
            {% for tag in trip.tags.all|slice:":3" %} 
            <span class="tag-badge">#{{ tag.ten }}</span>
            {% endfor %}
            {% if trip.tags.count > 3 %}
            <span class="tag-badge">+{{ trip.tags.count|add:"-3" }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="card-footer">
        <div class="organizer">
            {% if trip.nguoi_to_chuc.taikhoanhoso.avatar %}
                <img src="{{ trip.nguoi_to_chuc.taikhoanhoso.avatar.url }}" alt="Avatar">
            {% else %}
                <div class="default-avatar">{{ trip.nguoi_to_chuc.username|slice:":1"|upper }}</div>
            {% endif %}
            <div class="organizer-info">
                <span class="label">Host</span>
                <span class="name text-truncate" style="max-width: 100px;">{{ trip.nguoi_to_chuc.last_name|default:trip.nguoi_to_chuc.username }}</span>
            </div>
        </div>
        
        <div class="slots {% if trip.so_thanh_vien_tham_gia >= trip.so_luong_toi_da %}text-danger{% else %}text-success{% endif %}">
            <i class="fas fa-user-friends"></i> {{ trip.so_thanh_vien_tham_gia }}/{{ trip.so_luong_toi_da }}
        </div>
    </div>
</a>

<script>
(function(){
    document.querySelectorAll('.trip-status-badge').forEach(function(el){
        try { var c = el.dataset.color; if (c) { el.style.backgroundColor = c; el.classList.add('text-white'); } } catch(e) {}
    });
})();
</script>