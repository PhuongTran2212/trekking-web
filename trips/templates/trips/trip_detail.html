{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ trip.ten_chuyen_di }} - Trekking{% endblock %}

{% block extra_css %}
<!-- Font Awesome & Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- LightGallery -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.8.0/css/lightgallery-bundle.min.css"/>

<style>
    /* === GIỮ NGUYÊN CSS CỦA BẠN === */
    :root {
        --primary: #3e9f5f;
        --primary-dark: #2d7a46;
        --primary-light: #d1fae5;
        --secondary: #10b981;
        --success: #059669;
        --danger: #dc2626;
        --warning: #f59e0b;
        --info: #0891b2;
        --text-dark: #0f172a;
        --text-muted: #64748b;
        --bg-light: #f8fafc;
        --bg-lighter: #f1f5f9;
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 16px;
        --radius-xl: 20px;
    }

    * {
        transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    html, body {
        background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-lighter) 100%);
        color: var(--text-dark);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        scroll-behavior: smooth;
    }

    /* === HERO BANNER === */
    .trip-hero {
        position: relative;
        height: 60vh;
        min-height: 450px;
        width: 100%;
        overflow: hidden;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        display: flex;
        align-items: flex-end;
    }

    .trip-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top right, rgba(62, 159, 95, 0.3), transparent);
        z-index: 1;
    }

    .trip-hero-img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: brightness(0.65) saturate(1.1);
        z-index: 0;
    }

    .trip-hero-content {
        position: relative;
        z-index: 10;
        width: 100%;
        background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0.85) 100%);
        padding: 3rem 0 2.5rem;
        color: white;
    }

    .hero-inner {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .hero-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }

    .meta-badge {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.25);
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        animation: slideInUp 0.6s ease-out;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .meta-badge:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.35);
        transform: translateY(-2px);
    }
    
    /* Style riêng cho nút Copy */
    .meta-badge.copy-btn {
        cursor: pointer;
        background: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.4);
        color: #fcd34d;
    }
    .meta-badge.copy-btn:hover {
        background: rgba(245, 158, 11, 0.3);
    }

    .meta-badge i { font-size: 1rem; }

    .trip-title {
        font-weight: 900;
        font-size: clamp(1.8rem, 5vw, 3.5rem);
        color: white; 
        margin: 0;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        line-height: 1.1;
        letter-spacing: -0.5px;
        animation: slideInUp 0.7s ease-out 0.1s both;
    }

    .trip-meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        font-size: 0.95rem;
        animation: slideInUp 0.7s ease-out 0.2s both;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* === MAIN LAYOUT === */
    .main-container {
        margin-top: -50px;
        position: relative;
        z-index: 20;
        padding-bottom: 4rem;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2.5rem;
        align-items: start;
    }

    @media (max-width: 1024px) {
        .main-grid { grid-template-columns: 1fr; gap: 2rem; }
    }

    /* === CONTENT CARD === */
    .content-card {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.5);
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
        backdrop-filter: blur(10px);
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .content-inner { padding: 2.5rem; }

    /* === TABS === */
    .custom-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border-color);
        background: linear-gradient(135deg, var(--bg-lighter) 0%, #ffffff 100%);
        padding: 0;
        margin: 0;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }

    .custom-tabs .nav-link {
        border: none;
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.95rem;
        padding: 1.3rem 2rem;
        background: transparent;
        position: relative;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .custom-tabs .nav-link:hover {
        color: var(--primary);
        background: rgba(62, 159, 95, 0.08);
    }

    .custom-tabs .nav-link.active {
        color: var(--primary);
        font-weight: 700;
    }

    .custom-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 2px 2px 0 0;
        animation: expandWidth 0.3s ease-out;
    }

    @keyframes expandWidth {
        from { width: 0; left: 50%; }
        to { width: 100%; left: 0; }
    }

    .tab-content { padding: 2.5rem; min-height: 500px; }
    .tab-pane { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* === TIMELINE === */
 /* === TIMELINE STYLE MỚI === */
.timeline {
    position: relative;
    padding-left: 3.5rem; /* Tăng khoảng cách lề trái để chứa cục tròn to */
}

/* Đường kẻ dọc */
.timeline::before {
    content: '';
    position: absolute;
    left: 19px; /* Căn giữa theo chiều rộng của dot (40px / 2 - 1px border) */
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 50%, transparent 100%);
    z-index: 0;
}

.timeline-item {
    position: relative;
    margin-bottom: 2.8rem;
    padding-bottom: 1.5rem;
    transition: transform 0.3s ease;
}

.timeline-item:hover {
    transform: translateX(4px);
}

/* Dấu chấm tròn chứa số */
.timeline-dot {
    position: absolute;
    left: -3.5rem; /* Kéo ra lề trái trùng với padding của cha */
    top: 0;
    width: 40px;   /* Kích thước to hơn */
    height: 40px;
    background: white;
    border: 3px solid var(--primary); /* Viền xanh */
    border-radius: 50%;
    z-index: 2;
    
    /* Flexbox để căn số vào giữa */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Style cho số */
    color: var(--primary);
    font-weight: 800;
    font-size: 1.1rem;
    box-shadow: 0 4px 10px rgba(62, 159, 95, 0.2); /* Đổ bóng nhẹ cho đẹp */
    transition: all 0.3s ease;
}

/* Hiệu ứng khi hover vào item */
.timeline-item:hover .timeline-dot {
    background: var(--primary);
    color: white; /* Đổi số thành màu trắng */
    transform: scale(1.1);
    box-shadow: 0 0 0 6px var(--primary-light);
}

.timeline-time {
    font-weight: 700;
    color: var(--primary);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding-top: 8px; /* Căn chỉnh ngang hàng với số 1 */
}


    .timeline-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--text-dark);
        margin-bottom: 0.6rem;
    }

    .timeline-content {
        background: linear-gradient(135deg, #f0fdf4 0%, var(--bg-light) 100%);
        padding: 1.2rem 1.5rem;
        border-radius: var(--radius-md);
        border-left: 4px solid var(--primary);
        color: var(--text-muted);
        font-size: 0.95rem;
        line-height: 1.7;
        box-shadow: 0 2px 8px rgba(62, 159, 95, 0.08);
    }

    /* === GALLERY === */
    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
    }

    .gallery-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: var(--radius-lg);
        overflow: hidden;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: var(--bg-lighter);
        display: block; /* Fix for LightGallery anchor tags */
    }

    .gallery-item:hover {
        transform: translateY(-12px) scale(1.05);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .gallery-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }

    .gallery-item:hover .gallery-img { transform: scale(1.1); }

    .gallery-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%);
        display: flex;
        align-items: flex-end;
        padding: 1.2rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .gallery-item:hover .gallery-overlay { opacity: 1; }

    /* === CHAT CARD === */
    .chat-cta-card {
        background: linear-gradient(135deg, var(--primary-light) 0%, #a7f3d0 100%);
        border: 1px solid rgba(62, 159, 95, 0.2);
        border-radius: var(--radius-lg);
        padding: 3.5rem 2.5rem;
        text-align: center;
        box-shadow: 0 8px 32px rgba(62, 159, 95, 0.15);
        transition: all 0.3s ease;
    }
    .chat-cta-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(62, 159, 95, 0.2); }

    .chat-icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        margin-bottom: 2rem;
        box-shadow: 0 8px 24px rgba(62, 159, 95, 0.2);
        transition: all 0.3s ease;
    }
    .chat-cta-card:hover .chat-icon-wrapper { transform: scale(1.1); }
    .chat-icon-wrapper i { font-size: 2.5rem; color: var(--primary); }

    .chat-title { font-weight: 800; font-size: 1.6rem; color: var(--text-dark); margin-bottom: 1rem; }
    .chat-description { color: var(--text-muted); margin-bottom: 1.8rem; line-height: 1.7; }

    /* === BOOKING CARD (SIDEBAR) === */
    .booking-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 2.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.5);
        position: sticky;
        top: 100px;
        animation: fadeInUp 0.6s ease-out 0.1s both;
        backdrop-filter: blur(10px);
    }
    /* Chat card inside sidebar overrides */
    .booking-card .chat-cta-card {
        padding: 1.2rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(62,159,95,0.08);
        margin-top: 1.25rem;
        background: linear-gradient(135deg, rgba(62,159,95,0.06), rgba(16,185,129,0.03));
        border: 1px solid rgba(62,159,95,0.08);
        text-align: center;
    }
    .booking-card .chat-cta-card .chat-icon-wrapper { width: 56px; height: 56px; margin-bottom: 1rem;}
    .booking-card .chat-cta-card .chat-icon-wrapper i { font-size: 1.5rem; }
    .booking-card .chat-cta-card .chat-title { font-size: 1.05rem; margin-bottom: 0.5rem; }
    .booking-card .chat-cta-card .chat-description { font-size: 0.88rem; color: var(--text-muted); margin-bottom: 0.6rem; }
    .booking-card .chat-cta-card .btn { padding: 0.75rem; font-size: 0.9rem; }

    @media (max-width: 1024px) {
        .booking-card .chat-cta-card { margin-top: 1rem; }
        .booking-card { position: static; top: auto; }
    }

    .price-section {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
    }

    .price-label { font-size: 0.8rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); letter-spacing: 1px; }
    .price-amount {
        font-size: 2.2rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .price-unit { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); -webkit-text-fill-color: var(--text-muted); }

    /* === BOOKING STATS === */
    .booking-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        background: transparent;
        border-radius: var(--radius-md);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .stat-box {
        background: linear-gradient(135deg, #f0fdf4 0%, var(--bg-light) 100%);
        padding: 1.2rem;
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        transition: all 0.3s ease;
    }
    .stat-box:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(62, 159, 95, 0.1); }
    .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 0.5rem; letter-spacing: 0.8px; }
    .stat-value { font-weight: 800; font-size: 1.6rem; color: var(--primary); }

    /* === BUTTONS === */
    #main-action-area { display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 2rem; }
    .btn { border: none; border-radius: var(--radius-md); font-weight: 700; font-size: 0.95rem; padding: 1rem 1.8rem; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.6px; cursor: pointer; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; box-shadow: 0 6px 20px rgba(62, 159, 95, 0.3); }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(62, 159, 95, 0.4); color: white; }
    .btn-warning { background: var(--warning); color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2); }
    .btn-warning:hover { background: #d97706; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); color: white; }
    .btn-danger { background: transparent; color: var(--danger); border: 2px solid var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2); }
    .btn-secondary { background: var(--border-color); color: var(--text-muted); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .btn-secondary:hover { background: var(--bg-lighter); color: var(--text-dark); }
    .btn-lg { padding: 1.1rem 1.8rem; font-size: 1rem; }

    /* === ALERTS === */
    .alert { border: none; border-radius: var(--radius-lg); border-left: 5px solid; padding: 1.3rem 1.8rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .alert-info { background: rgba(6, 182, 212, 0.08); border-left-color: var(--info); color: #0c4a6e; }
    .alert-success { background: rgba(62, 159, 95, 0.08); border-left-color: var(--primary); color: var(--primary-dark); }
    .alert-warning { background: rgba(245, 158, 11, 0.08); border-left-color: var(--warning); color: #78350f; }
    .alert-danger { background: rgba(220, 38, 38, 0.08); border-left-color: var(--danger); color: #7f1d1d; }

    /* === MEMBER CARDS === */
    .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.5rem; }
    .member-card { background: linear-gradient(135deg, #f0fdf4 0%, var(--bg-light) 100%); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 1.5rem; text-align: center; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .member-card:hover { transform: translateY(-8px); box-shadow: 0 12px 24px rgba(62, 159, 95, 0.15); border-color: var(--primary); }
    .member-avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem; border: 3px solid var(--primary-light); transition: transform 0.3s ease; }
    .member-card:hover .member-avatar { transform: scale(1.1); }
    .member-name { font-weight: 700; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 1rem; }
    .member-role { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

    /* === ORGANIZER INFO === */
    .organizer-section { border-top: 2px solid var(--border-color); padding-top: 2rem; margin-top: 2rem; }
    .organizer-profile { display: flex; align-items: center; gap: 1.2rem; }
    .organizer-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-light); flex-shrink: 0; transition: transform 0.3s ease; }
    .organizer-profile:hover .organizer-avatar { transform: scale(1.1); }
    .organizer-info { flex: 1; }
    .organizer-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 0.4rem; letter-spacing: 0.8px; }
    .organizer-name { font-weight: 700; color: var(--text-dark); font-size: 1rem; }
    .organizer-link { color: var(--text-muted); margin-top: 1.2rem; text-align: center; text-decoration: none; font-weight: 600; font-size: 0.9rem; display: inline-block; width: 100%; padding: 0.6rem 0; transition: color 0.3s ease; }
    .organizer-link:hover { color: var(--primary); }

    /* === MAP === */
    #trip-map { height: 400px; width: 100%; border-radius: var(--radius-lg); border: 2px solid var(--border-color); z-index: 1; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
    .map-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 1rem; font-weight: 500; }
    .map-label i { color: var(--danger); margin-right: 0.6rem; }

    /* === EMPTY STATE === */
    .empty-state { background: linear-gradient(135deg, var(--bg-lighter) 0%, #ffffff 100%); border: 2px dashed var(--border-color); border-radius: var(--radius-lg); padding: 3.5rem 2rem; text-align: center; color: var(--text-muted); }
    .empty-state i { font-size: 3.5rem; margin-bottom: 1rem; opacity: 0.4; color: var(--primary); }
    .empty-state p { margin: 0; font-weight: 500; font-size: 0.95rem; }

    /* === MEMBER REQUEST CARD === */
    .request-card { background: linear-gradient(135deg, #ffffff 0%, var(--bg-lighter) 100%); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 1.5rem; display: flex; align-items: center; gap: 1.2rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .request-card:hover { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
    .request-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--primary-light); }
    .request-info { flex: 1; }
    .request-name { font-weight: 700; color: var(--text-dark); margin-bottom: 0.3rem; font-size: 0.95rem; }
    .request-reason { font-size: 0.85rem; color: var(--text-muted); font-style: italic; }
    .request-actions { display: flex; gap: 0.6rem; }
    .request-actions .btn { padding: 0.6rem 1.2rem; font-size: 0.8rem; }

    /* === UTILS === */
    .section-divider { border-top: 2px solid var(--border-color); padding-top: 2rem; margin-top: 2.5rem; }
    .section-divider--compact { border-top: 1px solid rgba(226,232,240,0.9); padding-top: 1rem; margin-top: 1.25rem; }
    .section-title { display: flex; align-items: center; gap: 0.6rem; font-weight: 800; color: var(--text-dark); margin-bottom: 1rem; }
    .progress { transform: translateY(-8px); margin-bottom: 0.75rem; }
    .progress-bar { transition: width 0.5s ease; }

    /* === LIGHTGALLERY OVERRIDES === */
    .lg-backdrop { background-color: rgba(0, 0, 0, 0.95) !important; }
    .lg-toolbar { background: transparent !important; height: 0 !important; }
    .lg-toolbar .lg-close { position: fixed !important; top: 20px !important; right: 20px !important; width: 50px !important; height: 50px !important; background: rgba(255, 255, 255, 0.2) !important; border-radius: 50%; cursor: pointer; z-index: 999999 !important; display: flex !important; align-items: center; justify-content: center; transition: transform 0.2s; text-decoration: none; }
    .lg-toolbar .lg-close:hover { background: rgba(255, 255, 255, 0.4) !important; transform: scale(1.1); }
    .lg-toolbar .lg-close:after { content: "\00d7"; font-size: 40px; line-height: 1; color: #fff; font-family: Arial, sans-serif; font-weight: 300; margin-top: -4px; }
    .lg-counter, .lg-download, .lg-maximize { display: none !important; }
    .lg-outer .lg-image { max-width: 90vw !important; max-height: 90vh !important; }
    .lg-actions .lg-next, .lg-actions .lg-prev { background-color: rgba(0,0,0,0.4); border-radius: 50%; width: 50px; height: 50px; }
    .lg-actions .lg-next:hover, .lg-actions .lg-prev:hover { background-color: var(--primary); }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        .trip-title { font-size: 1.8rem; }
        .hero-badges { gap: 0.5rem; }
        .meta-badge { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        .content-inner, .tab-content { padding: 1.8rem; }
        .custom-tabs { overflow-x: auto; }
        .custom-tabs .nav-link { padding: 1.1rem 1.5rem; font-size: 0.85rem; }
        .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .member-grid { grid-template-columns: repeat(2, 1fr); }
        .booking-card { padding: 2rem; }
        .main-grid { gap: 1.5rem; }
    }
    @media (max-width: 480px) {
        .trip-title { font-size: 1.4rem; }
        .meta-badge { font-size: 0.75rem; padding: 0.3rem 0.6rem; }
        .content-inner, .tab-content { padding: 1.2rem; }
        .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
        .member-grid { grid-template-columns: 1fr; }
        .request-card { flex-direction: column; text-align: center; }
        .request-actions { width: 100%; justify-content: center; }
        .request-actions .btn { flex: 1; }
        .chat-cta-card { padding: 2.5rem 1.5rem; }
    }
    .leaflet-control-attribution { background: rgba(255, 255, 255, 0.9) !important; border-radius: 4px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important; }
    .custom-pin-marker {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}



/* === FANCY SVG MARKER CSS === */
.svg-marker-container {
    position: relative;
    width: 50px;
    height: 60px;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); /* Đổ bóng cho toàn bộ ghim */
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.svg-marker-container:hover {
    transform: translateY(-5px) scale(1.1);
    cursor: pointer;
    z-index: 999;
}

/* Phần hình vẽ cái ghim (SVG) */
.svg-pin-shape {
    width: 100%;
    height: 100%;
    fill: var(--pin-color); /* Màu nền */
    stroke: white;          /* Viền trắng */
    stroke-width: 2px;
}

/* Phần Icon nằm đè lên trên */
.svg-pin-icon {
    position: absolute;
    top: 38%;         /* Căn chỉnh vị trí dọc */
    left: 50%;        /* Căn giữa ngang */
    transform: translate(-50%, -50%); /* Kỹ thuật căn giữa tuyệt đối */
    font-size: 18px;
    color: white;
    z-index: 10;
}

/* Hiệu ứng sóng (Pulse) cho điểm tập trung */
.pulse-animation {
    position: absolute;
    width: 100%;
    height: 40px;
    background: var(--pin-color);
    border-radius: 50%;
    bottom: 0;
    left: 0;
    z-index: -1;
    transform: scale(0.5);
    animation: pulse-effect 2s infinite;
    opacity: 0;
}

@keyframes pulse-effect {
    0% { transform: scale(0.2) translateY(20px); opacity: 0.8; }
    100% { transform: scale(1.5) translateY(20px); opacity: 0; }
}
/* Thêm vào phần style hiện có */
.progress {
    height: 12px !important; /* Cao hơn chút cho dễ nhìn */
    background-color: #e9ecef;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 1rem;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.progress-bar {
    height: 100%;
    /* Gradient xanh lá đẹp mắt */
    background: linear-gradient(90deg, #3e9f5f 0%, #10b981 100%);
    /* Hiệu ứng trượt mượt mà */
    transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 20px;
    /* Đảm bảo luôn hiện màu */
    opacity: 1 !important; 
    display: block !important;
}

/* Màu đỏ khi full */
.progress-bar.bg-danger {
    background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%) !important;
}
</style>
{% endblock %}

{% block content %}
<!-- 1. HERO BANNER -->
<div class="trip-hero">
    <!-- CẬP NHẬT 1: Dùng cover_url tự động lấy ảnh -->
    <img src="{{ trip.cover_url }}" class="trip-hero-img" alt="{{ trip.ten_chuyen_di }}">
    
    <div class="trip-hero-content">
        <div class="container">
            <div class="hero-inner">
                <div class="hero-badges">
                    <span class="meta-badge"><i class="fas fa-check-circle"></i> {{ trip.trang_thai.ten }}</span>
                    <span class="meta-badge"><i class="fas fa-mountain"></i> {{ trip.cung_duong.do_kho.ten }}</span>
                </div>
                <h1 class="trip-title">{{ trip.ten_chuyen_di }}</h1>
                <div class="trip-meta-row">
                    <div class="meta-badge"><i class="fas fa-map-marker-alt"></i> {{ trip.cung_duong.tinh_thanh.ten }}</div>
                    <div class="meta-badge"><i class="far fa-calendar-alt"></i> {{ trip.ngay_bat_dau|date:"d/m/Y H:i" }}</div>
                    <div class="meta-badge"><i class="fas fa-clock"></i> {{ trip.ngay_ket_thuc|date:"d/m/Y H:i" }}</div>
                    
                    <!-- CẬP NHẬT 2: Nút COPY mã chuyến đi -->
                    <div class="meta-badge copy-btn" onclick="copyTripCode('{{ trip.ma_moi }}')" title="Sao chép mã chuyến đi">
                        <i class="fa-solid fa-qrcode"></i> Mã: {{ trip.ma_moi|slice:":8" }} <i class="far fa-copy ms-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2. MAIN CONTENT -->
<div class="container main-container">
    <div class="main-grid">
        
        <!-- CỘT TRÁI: NỘI DUNG CHÍNH (TABS) -->
        <div>
            <div class="content-card">
                <!-- Tabs Navigation -->
                <div style="display: flex; gap: 0; border-bottom: 2px solid var(--border-color);">
                    <ul class="nav custom-tabs flex-fill" id="tripTab" role="tablist" style="margin: 0;">
                        <li class="nav-item" style="flex: 1;"><button class="nav-link active w-100 text-start" data-bs-toggle="tab" data-bs-target="#overview"><i class="fas fa-info-circle me-2"></i> Tổng quan</button></li>
                        <li class="nav-item" style="flex: 1;"><button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#members"><i class="fas fa-users me-2"></i> Thành viên</button></li>
                        <li class="nav-item" style="flex: 1;"><button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#media"><i class="fas fa-images me-2"></i> Thư viện</button></li>
                    </ul>
                </div>

                <div class="tab-content">
                    <!-- Tab Tổng quan -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="intro-block">
                            <h4 class="section-title" style="margin-top:0;">Giới thiệu chuyến đi</h4>
                            <!-- CẬP NHẬT 3: Dùng safe để hiển thị HTML từ TinyMCE, bỏ pre-line -->
                            <div style="color: var(--text-muted); margin-bottom: 2.5rem; line-height: 1.7;">
                                {{ trip.mo_ta|safe }}
                            </div>
                        </div>

                        <div class="section-divider">
                            <h4 class="section-title"> Lịch trình chi tiết</h4>
<div class="timeline">
    {% for item in trip.timeline.all %}
    <div class="timeline-item">
        <!-- ĐƯA SỐ THỨ TỰ VÀO TRONG DOT -->
        <div class="timeline-dot">{{ forloop.counter }}</div>
        
        <!-- BỎ SỐ THỨ TỰ Ở ĐÂY, CHỈ GIỮ NGÀY GIỜ -->
        <div class="timeline-time">Ngày {{ item.ngay }} - {{ item.thoi_gian|time:"H:i" }}</div>
        
        <div class="timeline-title">{{ item.hoat_dong }}</div>
        {% if item.mo_ta_chi_tiet %}
            <div class="timeline-content">{{ item.mo_ta_chi_tiet }}</div>
        {% endif %}
    </div>
    {% empty %}
    <div class="empty-state" style="padding: 2rem 1rem;">
        <i class="fas fa-calendar-alt"></i>
        <p>Chưa có lịch trình chi tiết.</p>
    </div>
    {% endfor %}
</div>
                        </div>

<div class="section-divider">
    <h4 class="section-title">Bản đồ & Địa điểm</h4>

    <!-- PHẦN 1: ĐIỂM TẬP TRUNG -->
    <div class="mb-5">
        <h5 class="fw-bold text-dark mb-3">
            <i class="fas fa-map-pin text-danger me-2"></i>1. Điểm tập trung
        </h5>
        
        {% if trip.dia_diem_tap_trung %}
            <p class="text-muted mb-3"><i class="fas fa-location-arrow me-1"></i> {{ trip.dia_diem_tap_trung }}</p>
        {% else %}
            <p class="text-muted fst-italic mb-3">Chưa cập nhật địa chỉ cụ thể.</p>
        {% endif %}

        {% if trip.toa_do_tap_trung.lat %}
            <div id="map-meeting" style="height: 300px; width: 100%; border-radius: var(--radius-lg); border: 1px solid var(--border-color);"></div>
        {% else %}
            <div class="alert alert-secondary border-0 small">
                <i class="fas fa-eye-slash me-2"></i>Chưa có tọa độ bản đồ cho điểm tập trung.
            </div>
        {% endif %}
    </div>

    <!-- PHẦN 2: CUNG ĐƯỜNG TREKKING -->
    <div>
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="fw-bold text-dark mb-0">
               <i class="fa-regular fa-map" style="color: #06a23a"></i> 2. Lộ trình Trekking
            </h5>
            
            <!-- TAG KHOẢNG CÁCH (Yêu cầu của bạn) -->
            {% if trip.cd_do_dai_km > 0 %}
            <span class="badge bg-success rounded-pill px-3 py-2" style="font-size: 0.9rem;">
               <i class="fa-solid fa-route me-2"></i> Tổng độ dài: {{ trip.cd_do_dai_km }} km
            </span>
            {% endif %}
        </div>

        {% if trip.cd_du_lieu_ban_do_geojson %}
            <div id="map-trek" style="height: 350px; width: 100%; border-radius: var(--radius-lg); border: 1px solid var(--border-color);"></div>
            
            <!-- Chú thích nhỏ -->
            <div class="d-flex gap-3 mt-2 small text-muted justify-content-center">
                <div><i class="fas fa-map-marker-alt text-success"></i> Xuất phát</div>
                <div><i class="fas fa-long-arrow-alt-right text-muted"></i></div>
                <div><i class="fas fa-flag-checkered text-danger"></i> Kết thúc</div>
            </div>
        {% else %}
            <div class="alert alert-secondary border-0 small">
                <i class="fas fa-map-signs me-2"></i>Chưa cập nhật dữ liệu bản đồ cung đường.
            </div>
        {% endif %}
    </div>
</div>
                    </div>

                    <!-- Tab Thành viên -->
                    <div class="tab-pane fade" id="members" role="tabpanel">
                        {% if is_organizer and pending_requests %}
                        <div class="alert alert-warning">
                            <h6 style="font-weight: 800; margin-bottom: 1rem;"><i class="fas fa-user-clock me-2"></i>Yêu cầu chờ duyệt ({{ pending_requests.count }})</h6>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                {% for req in pending_requests %}
                                <div class="request-card">
                                    <img src="{{ req.user.taikhoanhoso.avatar_url|default:'/static/images/default-avatar.png' }}" class="request-avatar" alt="{{ req.user.username }}">
                                    <div class="request-info">
                                        <div class="request-name">{{ req.user.get_full_name|default:req.user.username }}</div>
                                        {% if req.ly_do_tham_gia %}<div class="request-reason">"{{ req.ly_do_tham_gia }}"</div>{% endif %}
                                    </div>
                                    <div class="request-actions">
                                        <button class="btn btn-success btn-sm approve-btn" data-member-id="{{ req.id }}"><i class="fas fa-check me-1"></i> Duyệt</button>
                                        <button class="btn btn-danger btn-sm reject-btn" data-member-id="{{ req.id }}"><i class="fas fa-times me-1"></i> Từ chối</button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="section-divider">
                            <h5 class="section-title" style="font-size: 1.2rem;">Danh sách tham gia ({{ trip.so_thanh_vien_tham_gia }})</h5>
                            <div class="member-grid">
                                {% for member in trip.thanh_vien.all %}
                                    {% if member.trang_thai_tham_gia == 'DA_THAM_GIA' %}
                                    <div class="member-card">
                                        <img src="{{ member.user.taikhoanhoso.avatar_url|default:'/static/images/default-avatar.png' }}" class="member-avatar" alt="{{ member.user.username }}">
                                        <div class="member-name">{{ member.user.get_full_name|default:member.user.username }}</div>
                                        {% if member.vai_tro == 'TRUONG_DOAN' %}
                                            <div style="display: inline-block; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700; margin-top: 0.5rem;">Trưởng đoàn</div>
                                        {% else %}
                                            <div class="member-role">Thành viên</div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        {% if not trip.thanh_vien.all %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Chưa có thành viên nào tham gia.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Tab Thư viện -->
                    <div class="tab-pane fade" id="media" role="tabpanel">
                       <div class="section-divider">
                           <h4 class="section-title">Thư viện ảnh ({{ trip.media.count }})</h4>
                        {% if trip.media.all %}
                        <div id="light-gallery" class="gallery-grid">
                            {% for media in trip.media.all %}
                                {% if media.loai_media == 'VIDEO' %}
                                    <a href="{{ media.file.url }}" class="gallery-item" data-sub-html="Đăng bởi: {{ media.user.username }}">
                                        <div style="background: var(--text-dark); color: white; display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; gap: 0.5rem;">
                                            <i class="fas fa-video" style="font-size: 2rem;"></i>
                                            <small>Video</small>
                                        </div>
                                        <div class="gallery-overlay">
                                            <div style="width: 100%;"> <i class="fas fa-user-circle me-1"></i> {{ media.user.username }}</div>
                                        </div>
                                    </a>
                                {% else %}
                                    <a href="{{ media.file.url }}" class="gallery-item" data-sub-html="Đăng bởi: {{ media.user.username }}">
                                        <img src="{{ media.file.url }}" class="gallery-img" loading="lazy" alt="Trip Media">
                                        <div class="gallery-overlay">
                                            <div style="width: 100%;"> <i class="fas fa-user-circle me-1"></i> {{ media.user.username }}</div>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                            <div class="empty-state">
                                <i class="far fa-images"></i>
                                <p>Chưa có hình ảnh nào được chia sẻ.</p>
                            </div>
                        {% endif %}
                       </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CỘT PHẢI: BOOKING CARD (Sticky) -->
  <div>
    <div class="booking-card">
        
        <div class="price-section">
            <div>
                <div class="price-label">Chi phí dự kiến</div>
                <div class="price-amount">
                    {% if trip.chi_phi_uoc_tinh > 0 %}
                        {{ trip.chi_phi_uoc_tinh|intcomma }}<span class="price-unit"> vnđ</span>
                    {% else %}
                        <span style="font-size: 1.8rem; color: var(--success);">Miễn phí</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="booking-stats">
            <div class="stat-box">
                <div class="stat-label">Đã tham gia</div>
                <div class="stat-value">{{ trip.so_thanh_vien_tham_gia|default:"0" }}</div>
            </div>
            <div class="stat-box" style="border-left: 1px solid var(--border-color);">
                <div class="stat-label">Tối đa</div>
                <div class="stat-value">{{ trip.so_luong_toi_da }}</div>
            </div>
        </div>

        {% if trip.so_luong_toi_da > 0 %}
            {% widthratio trip.so_thanh_vien_tham_gia|default:0 trip.so_luong_toi_da 100 as percent %}
        {% else %}
            {% with percent="0" %}{% endwith %}
        {% endif %}

        <div class="d-flex justify-content-between align-items-end mb-1">
            <small class="text-muted fw-bold text-uppercase" style="font-size: 0.75rem;">Tiến độ</small>
            <small class="fw-bold {% if percent|add:'0' >= 100 %}text-danger{% else %}text-success{% endif %}">
                {{ percent|default:"0" }}%
            </small>
        </div>

        <div class="progress">
            <div class="progress-bar {% if percent|add:'0' >= 100 %}bg-danger{% endif %}" 
                 role="progressbar" 
                 style="width: {{ percent|default:'0' }}%" 
                 aria-valuenow="{{ percent|default:'0' }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
            </div>
        </div>

        <div id="main-action-area" class="d-flex flex-column gap-2 mb-4">
            
            {# --- TRƯỜNG HỢP 1: BỊ HỦY / HOÃN / KẾT THÚC --- #}
            {% if trip.trang_thai == 'DA_HUY' %}
                <button class="btn btn-danger btn-lg w-100" disabled>
                    <i class="fas fa-ban me-2"></i> ĐÃ HỦY CHUYẾN
                </button>
            {% elif trip.trang_thai == 'TAM_HOAN' %}
                <button class="btn btn-secondary btn-lg w-100" disabled>
                    <i class="fas fa-pause-circle me-2"></i> ĐANG TẠM HOÃN
                </button>
            {% elif trip.dynamic_status_info.name == 'Đã kết thúc' %}
                <button class="btn btn-secondary btn-lg w-100" disabled>
                    <i class="fas fa-flag-checkered me-2"></i> ĐÃ KẾT THÚC
                </button>

            {# --- TRƯỜNG HỢP 2: BÌNH THƯỜNG --- #}
            {% else %}
                
                {% if not user.is_authenticated %}
                    <a href="{% url 'accounts:dang-nhap' %}?next={{ request.path }}" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-sign-in-alt me-2"></i> Đăng nhập ngay
                    </a>

                {% elif is_organizer %}
                    <a href="{% url 'trips:update_trip' pk=trip.pk slug=trip.slug %}" class="btn btn-warning btn-lg w-100">
                        <i class="fas fa-edit me-2"></i> Chỉnh sửa
                    </a>

                {% else %}
                    {% if not membership %}
                        {% if trip.so_thanh_vien_tham_gia >= trip.so_luong_toi_da %}
                             <button class="btn btn-secondary btn-lg w-100" disabled>
                                 <i class="fas fa-user-slash me-2"></i> Hết chỗ
                             </button>
                        {% else %}
                            <button id="join-trip-btn" class="btn btn-primary btn-lg w-100 shadow-sm"
                                {% if trip.yeu_cau_ly_do %} data-bs-toggle="modal" data-bs-target="#joinReasonModal" {% endif %}>
                                <i class="fas fa-paper-plane me-2"></i> THAM GIA NGAY
                            </button>
                            <p class="text-center small text-muted mt-2 mb-0">
                                Chỉ còn <strong>{{ trip.so_cho_con_lai }}</strong> chỗ trống!
                            </p>
                        {% endif %}
                    
                    {% elif membership.trang_thai_tham_gia == 'DA_GUI_YEU_CAU' %}
                        <div class="alert alert-info text-center py-2 mb-2 fw-bold">
                            <i class="fas fa-clock me-1"></i> Đang chờ duyệt
                        </div>
                        <button id="cancel-request-btn" class="btn btn-outline-danger btn-sm w-100">Hủy yêu cầu</button>
                    
                    {% elif membership.trang_thai_tham_gia == 'DA_THAM_GIA' %}
                        <div class="alert alert-success text-center py-2 mb-2 fw-bold">
                            <i class="fas fa-check-circle me-1"></i> Đã tham gia
                        </div>
                        <button id="leave-trip-btn" class="btn btn-outline-secondary btn-sm w-100 border-0">
                            Rời chuyến đi
                        </button>
                    
                    {% elif membership.trang_thai_tham_gia == 'BI_TU_CHOI' %}
                        <div class="alert alert-danger text-center py-2 mb-0 fw-bold">Bị từ chối</div>
                    
                    {% elif membership.trang_thai_tham_gia == 'DA_ROI_DI' %}
                        <div class="text-center text-muted small mb-2">Bạn đã rời đi</div>
                        {% if trip.so_thanh_vien_tham_gia < trip.so_luong_toi_da %}
                            <button id="join-trip-btn" class="btn btn-outline-primary w-100" 
                                {% if trip.yeu_cau_ly_do %} data-bs-toggle="modal" data-bs-target="#joinReasonModal" {% endif %}>
                                Tham gia lại
                            </button>
                        {% endif %}
                    {% endif %}
                {% endif %}

            {% endif %}
        </div>

        <div class="chat-cta-card">
            <div class="chat-icon-wrapper"><i class="fas fa-comments"></i></div>
            <div class="chat-title">Thảo luận nhóm</div>
            
            {% if is_member or is_organizer %}
                <div class="chat-description">Trao đổi, lên kế hoạch và chia sẻ khoảnh khắc với mọi người.</div>
                {% if trip.get_chat_url %}
                    <a href="{{ trip.get_chat_url }}" class="btn btn-primary w-100 mb-2 shadow-sm">
                        <i class="fas fa-external-link-alt me-2"></i> Truy cập Group Chat
                    </a>
                {% else %}
                    <button class="btn btn-secondary w-100 mb-2" disabled>
                        <i class="fas fa-tools me-2"></i> Đang khởi tạo...
                    </button>
                {% endif %}
                <small class="text-muted d-block text-center fst-italic">Khu vực dành riêng cho thành viên</small>
            {% else %}
                <div class="chat-description">Kênh chat chỉ dành cho thành viên chính thức. Hãy đăng ký ngay!</div>
                <button class="btn btn-outline-primary w-100" onclick="document.getElementById('join-trip-btn').click()">
                    <i class="fas fa-arrow-up me-2"></i> Đăng ký ở trên
                </button>
            {% endif %}
        </div>

                <!-- Organizer Info -->
                <div class="organizer-section">
                    <div class="organizer-profile">
                        <img src="{{ trip.nguoi_to_chuc.taikhoanhoso.avatar_url|default:'/static/images/default-avatar.png' }}" class="organizer-avatar" alt="{{ trip.nguoi_to_chuc.username }}">
                        <div class="organizer-info">
                            <div class="organizer-label">Tổ chức bởi</div>
                            <a href="#" class="organizer-name text-decoration-none" style="color: var(--text-dark);">{{ trip.nguoi_to_chuc.get_full_name|default:trip.nguoi_to_chuc.username }}</a>
                        </div>
                    </div>
                    
                    <a href="{{ trip.cung_duong.get_absolute_url }}" class="organizer-link">
                        Xem chi tiết Cung đường <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>   
            </div>
        </div>
    </div>
</div>

<!-- Modal Lý do tham gia -->
<div class="modal fade" id="joinReasonModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: var(--radius-lg);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Gửi lời nhắn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Trưởng đoàn muốn biết lý do bạn tham gia chuyến đi này.</p>
                <textarea id="join-reason" class="form-control" style="background: var(--bg-lighter); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 0.8rem;" rows="4" placeholder="Nhập lý do của bạn..."></textarea>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="submit-join-request" class="btn btn-primary fw-bold">Gửi yêu cầu</button>
            </div>
        </div>
    </div>
</div>


<!-- Hidden Data -->
{{ trip.cd_du_lieu_ban_do_geojson|json_script:"trip-map-data" }}
{{ trip.toa_do_tap_trung|json_script:"trip-meeting-point-data" }}

{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.0/lightgallery.umd.min.js"></script>

<script>
    // Hàm copy mã chuyến đi
    function copyTripCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            alert("Đã sao chép mã chuyến đi: " + code);
        }).catch(err => {
            console.error('Không thể sao chép: ', err);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = '{{ csrf_token }}';
        
        // ==========================================
        // 1. CÁC HÀM HELPER
        // ==========================================
        
        // Helper: Gửi AJAX
        const sendAjax = (url, method='POST', body=null) => {
            return fetch(url, {
                method: method,
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: body
            }).then(res => res.json()).then(data => {
                if(data.status === 'success') { 
                    alert(data.message); 
                    window.location.reload(); 
                } else { 
                    alert(data.message); 
                }
            }).catch(err => console.error(err));
        };

        // Helper: Tạo Icon SVG Đẹp cho bản đồ
        function createFancyIcon(iconClass, color, withPulse = false) {
            const pinPath = "M24 0C10.7 0 0 10.7 0 24c0 18.2 24 40 24 40s24-21.8 24-40C48 10.7 37.3 0 24 0z";
            
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="svg-marker-container" style="--pin-color: ${color};">
                        ${withPulse ? '<div class="pulse-animation"></div>' : ''}
                        <svg viewBox="0 0 48 64" class="svg-pin-shape">
                            <path d="${pinPath}"></path>
                        </svg>
                        <i class="fas ${iconClass} svg-pin-icon"></i>
                    </div>
                `,
                iconSize: [50, 60],
                iconAnchor: [25, 60],
                popupAnchor: [0, -55]
            });
        }

        // ==========================================
        // 2. XỬ LÝ NÚT BẤM (JOIN/LEAVE/DUYỆT)
        // ==========================================
        
        const actionArea = document.getElementById('main-action-area');
        if(actionArea) {
            actionArea.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if(!btn) return;
                
                if(btn.id === 'join-trip-btn' && !btn.dataset.bsToggle) {
                    if(confirm('Xác nhận tham gia?')) sendAjax(`{% url 'trips:join_trip' trip.pk %}`);
                }
                if(btn.id === 'cancel-request-btn' && confirm('Hủy yêu cầu?')) sendAjax(`{% url 'trips:cancel_join_request' trip.pk %}`);
                if(btn.id === 'leave-trip-btn' && confirm('Rời chuyến đi?')) sendAjax(`{% url 'trips:leave_trip' trip.pk %}`);
            });
        }

        document.getElementById('submit-join-request')?.addEventListener('click', () => {
            const reason = document.getElementById('join-reason').value;
            const fd = new FormData(); fd.append('reason', reason);
            const modalEl = document.getElementById('joinReasonModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            sendAjax(`{% url 'trips:join_trip' trip.pk %}`, 'POST', fd);
        });

        const membersPane = document.getElementById('members');
        if(membersPane) {
            membersPane.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if(!btn) return;
                const id = btn.dataset.memberId;
                if(btn.classList.contains('approve-btn')) sendAjax(`{% url 'trips:approve_member' trip.pk 0 %}`.replace('0', id));
                if(btn.classList.contains('reject-btn')) sendAjax(`{% url 'trips:reject_member' trip.pk 0 %}`.replace('0', id));
            });
        }

        // ==========================================
        // 3. XỬ LÝ BẢN ĐỒ (LEAFLET)
        // ==========================================

        // Map 1: Điểm tập trung
        const meetingMapEl = document.getElementById('map-meeting');
        if (meetingMapEl) {
            const rawMeetPoint = document.getElementById('trip-meeting-point-data').textContent;
            const meetPoint = rawMeetPoint ? JSON.parse(rawMeetPoint) : null;

            if (meetPoint && meetPoint.lat) {
                const map1 = L.map(meetingMapEl).setView([meetPoint.lat, meetPoint.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map1);
                
                const meetIcon = createFancyIcon('fa-users', '#3b82f6', true); // Xanh dương

                L.marker([meetPoint.lat, meetPoint.lng], { icon: meetIcon })
                 .addTo(map1)
                 .bindPopup('<b>📍 ĐIỂM TẬP TRUNG</b><br>Tập hợp tại đây.')
                 .openPopup();
                
                setTimeout(() => map1.invalidateSize(), 500); 
            }
        }

        // Map 2: Cung đường Trek
        const trekMapEl = document.getElementById('map-trek');
        if (trekMapEl) {
            const rawMapData = document.getElementById('trip-map-data').textContent;
            const mapData = rawMapData ? JSON.parse(rawMapData) : null;

            if (mapData && Object.keys(mapData).length > 0) {
                const map2 = L.map(trekMapEl);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2);

                const routeLayer = L.geoJSON(mapData, {
                    style: { color: '#16a34a', weight: 5, opacity: 0.8 }
                }).addTo(map2);

                let coordinates = [];
                if (mapData.features && mapData.features.length > 0) {
                    const geom = mapData.features[0].geometry;
                    coordinates = (geom.type === 'LineString') ? geom.coordinates : geom.coordinates[0];
                } else if (mapData.type === 'LineString') {
                    coordinates = mapData.coordinates;
                }

                if (coordinates.length > 0) {
                    const start = [coordinates[0][1], coordinates[0][0]];
                    const end = [coordinates[coordinates.length - 1][1], coordinates[coordinates.length - 1][0]];

                    const startIcon = createFancyIcon('fa-hiking', '#10b981'); // Xanh lá
                    const endIcon = createFancyIcon('fa-flag-checkered', '#ef4444'); // Đỏ

                    L.marker(start, { icon: startIcon }).addTo(map2).bindPopup('<b>🚩 XUẤT PHÁT</b><br>Bắt đầu hành trình.');
                    L.marker(end, { icon: endIcon }).addTo(map2).bindPopup('<b>🏁 KẾT THÚC</b><br>Hoàn thành.');
                }

                map2.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                setTimeout(() => map2.invalidateSize(), 500);
            } else {
                const map2 = L.map(trekMapEl).setView([16.0, 108.0], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2);
            }
        }

        // ==========================================
        // 4. KHỞI TẠO LIGHTGALLERY
        // ==========================================
        const lgRoot = document.getElementById('light-gallery');
        if (lgRoot) {
            lightGallery(lgRoot, {
                selector: 'a',
                speed: 300,
                controls: true,
                closable: true,
                download: false,
                counter: false,
                hideBarsDelay: 999999,
                mode: 'lg-fade',
                mousewheel: true,
                getCaptionFromTitleOrAlt: false
            });
        }

   // ==========================================
    // 5. HIỆU ỨNG PROGRESS BAR (FIX LỖI KHÔNG CHẠY)
    // ==========================================
    
    // Tìm phần tử
    const progressBar = document.getElementById('trip-progress-bar');
    const progressText = document.getElementById('progress-text');

    if (progressBar) {
        // Lấy giá trị phần trăm từ data-percent
        // Ép kiểu float để tránh lỗi text
        let percent = parseFloat(progressBar.getAttribute('data-percent')) || 0;
        
        // Giới hạn max 100
        if (percent > 100) percent = 100;

        // Debug: Xem console trình duyệt có in ra số này không
        console.log("Javscript: Đang set width thành " + percent + "%");

        // Logic đổi màu: Nếu >= 100% thì chuyển màu đỏ
        if (percent >= 100) {
            progressBar.classList.add('bg-danger');
            if(progressText) {
                progressText.classList.remove('text-success');
                progressText.classList.add('text-danger');
                progressText.innerHTML = 'HẾT CHỖ';
            }
        }

        // Kỹ thuật ép trình duyệt vẽ lại (Reflow) trước khi chạy animation
        // Giúp đảm bảo hiệu ứng trượt từ 0 -> X% hoạt động
        void progressBar.offsetWidth; 

        // Đặt độ trễ nhỏ 100ms rồi mới set width
        setTimeout(() => {
            progressBar.style.width = percent + "%";
        }, 100);
        } 
  });
</script>
{% endblock %}