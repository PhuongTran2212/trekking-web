{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Chat: {{ trip.ten_chuyen_di }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.8.0/css/lightgallery-bundle.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --primary: #10b981;
        --primary-hover: #059669;
        --primary-light: #ecfdf5;
        --primary-dark: #047857;
        --bg-chat: #ffffff;
        --bg-sidebar: #fafafa;
        --bg-hover: #f5f5f5;
        --border-color: #e5e7eb;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --bubble-me: #10b981;
        --bubble-other: #f3f4f6;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.06);
        
        --sb-left-w: 300px;
        --sb-right-w: 300px;
    }

    body { overflow: hidden; height: 100vh; background: #fafafa; }
    
    /* ==================================================
       LAYOUT CHÍNH
       ================================================== */
    .chat-layout {
        display: flex;
        height: calc(100vh - 65px);
        background: white;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        position: relative;
        overflow: hidden;
    }

    /* ==================================================
       1. CỘT TRÁI - DANH SÁCH NHÓM
       ================================================== */
    .left-sidebar {
        width: var(--sb-left-w);
        background: white;
        border-right: 1px solid var(--border-color);
        display: flex; 
        flex-direction: column;
        transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        z-index: 20;
    }
    
    .left-sidebar.collapsed {
        margin-left: calc(var(--sb-left-w) * -1);
    }

    .ls-header {
        height: 70px;
        padding: 0 20px;
        display: flex; 
        align-items: center;
        gap: 10px;
        font-weight: 700; 
        font-size: 1.1rem; 
        color: var(--text-main);
        border-bottom: 1px solid var(--border-color);
        background: white;
    }
    
    .ls-header i {
        color: var(--primary);
        font-size: 1.2rem;
    }

    .group-list { 
        flex: 1; 
        overflow-y: auto; 
        padding: 12px;
        background: white;
    }
    
    .group-list::-webkit-scrollbar { width: 6px; }
    .group-list::-webkit-scrollbar-track { background: transparent; }
    .group-list::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    
    .group-item {
        display: flex; 
        align-items: center; 
        padding: 12px;
        border-radius: 10px; 
        text-decoration: none; 
        color: inherit;
        transition: all 0.2s;
        margin-bottom: 6px;
        background: white;
        border: 1px solid transparent;
    }
    
    .group-item:hover { 
        background: var(--bg-hover);
    }
    
    .group-item.active {
        background: var(--primary-light);
        border-color: var(--primary);
    }
    
    .group-avatar { 
        width: 44px; 
        height: 44px; 
        border-radius: 10px; 
        object-fit: cover; 
        margin-right: 12px;
    }
    
    .group-info { flex: 1; overflow: hidden; }
    
    .group-name { 
        font-weight: 600; 
        font-size: 0.9rem; 
        color: var(--text-main); 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
        margin-bottom: 4px;
    }
    
    .group-status { 
        font-size: 0.8rem; 
        color: var(--text-sub);
        font-weight: 500;
    }
    
    .group-status .text-primary {
        color: var(--primary) !important;
        font-weight: 700;
    }

    /* ==================================================
       2. CỘT GIỮA - CHAT CHÍNH
       ================================================== */
    .chat-center {
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        min-width: 0;
        background: var(--bg-chat);
        position: relative;
    }

    /* Header */
    .chat-header {
        height: 70px; 
        padding: 0 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex; 
        align-items: center; 
        justify-content: space-between;
        background: white;
        z-index: 10;
    }

    .header-left { 
        display: flex; 
        align-items: center; 
        gap: 15px;
        flex: 1;
    }
    
    /* Toggle Button */
    .toggle-sidebar-btn {
        width: 38px; 
        height: 38px; 
        border-radius: 8px;
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer; 
        color: var(--text-sub); 
        transition: all 0.2s;
        background: white;
        border: 1px solid var(--border-color);
        font-size: 1rem;
    }
    
    .toggle-sidebar-btn:hover { 
        background: var(--bg-hover);
        color: var(--primary);
    }

    .header-info { 
        display: flex; 
        align-items: center;
        gap: 12px;
    }
    
    .header-info img { 
        width: 40px; 
        height: 40px; 
        border-radius: 50%; 
        object-fit: cover; 
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .header-text { line-height: 1.3; }
    
    .header-title { 
        font-weight: 700; 
        color: var(--text-main); 
        font-size: 1rem;
        margin-bottom: 2px;
    }
    
    .header-status { 
        font-size: 0.8rem; 
        color: var(--primary); 
        font-weight: 600;
        display: flex; 
        align-items: center; 
        gap: 6px;
    }
    
    .header-status i {
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Messages Area */
    .chat-messages {
        flex: 1; 
        padding: 20px; 
        overflow-y: auto;
        display: flex; 
        flex-direction: column; 
        gap: 4px;
        background: #fafafa;
    }
    
    .chat-messages::-webkit-scrollbar { width: 8px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { 
        background: #d1d5db; 
        border-radius: 10px; 
    }

    /* Loading Spinner */
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        gap: 1rem;
    }
    
    .spinner-border {
        border-color: var(--primary-light);
        border-right-color: var(--primary);
    }

    /* --- Date Divider --- */
    .date-divider { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        margin: 20px 0; 
    }
    .date-divider span { 
        background-color: #e5e7eb; 
        color: var(--text-sub); 
        padding: 4px 12px; 
        border-radius: 12px; 
        font-size: 0.75rem; 
        font-weight: 600; 
    }

    /* Message Bubbles */
    .msg-row { 
        display: flex; 
        margin-bottom: 12px; 
        align-items: flex-end; 
        animation: fadeInUp 0.2s ease;
        gap: 10px;
    }
    
    .msg-row.me { 
        justify-content: flex-end; 
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .msg-avatar { 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        object-fit: cover; 
        flex-shrink: 0;
    }
    
    .msg-content { 
        max-width: 75%; /* Tăng chiều rộng tối đa lên 75% */
        display: flex; 
        flex-direction: column;
        gap: 4px;
        min-width: 0; /* Quan trọng: giúp flex item co lại đúng cách khi nội dung quá dài */
    }
    
    .msg-row.me .msg-content { 
        align-items: flex-end; 
    }

    .msg-name { 
        font-size: 0.75rem; 
        color: var(--text-sub); 
        margin-left: 12px; 
        font-weight: 600;
    }
    
    .msg-row.me .msg-name { 
        display: none; 
    }

    .msg-bubble {
        padding: 10px 14px; 
        font-size: 0.95rem; 
        line-height: 1.5;
        position: relative; 
        
        /* Cấu hình xuống dòng cho text dài */
        overflow-wrap: break-word;
        word-wrap: break-word; 
        word-break: break-word; /* Hỗ trợ ngắt từ tốt hơn */
        
        max-width: 100%; /* Đảm bảo không tràn khỏi container cha */
    }
    
    /* Bubble của người khác */
    .msg-row:not(.me) .msg-bubble {
        background: var(--bubble-other);
        color: var(--text-main);
        border-radius: 16px 16px 16px 4px;
    }
    
    /* Bubble của mình */
    .msg-row.me .msg-bubble {
        background: var(--bubble-me);
        color: white;
        border-radius: 16px 16px 4px 16px;
    }

    /* --- FEATURE: Messenger-style Reply Bubble --- */
    .msg-reply-bubble { 
        background: rgba(0,0,0,0.06); 
        border-radius: 8px; 
        padding: 8px 12px; 
        margin-bottom: 8px; 
        font-size: 0.8rem; 
        border-left: 3px solid var(--primary); 
        cursor: pointer; 
        user-select: none;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .msg-row.me .msg-reply-bubble { 
        background: rgba(0,0,0,0.15); /* Nền tối hơn chút trên nền xanh */
        border-left-color: rgba(255,255,255,0.7); 
        color: white; 
    }

    /* FEATURE MỚI: Cắt ngắn nội dung reply bằng CSS Height + JS Truncate */
    .reply-content-truncate {
        display: block; /* Bỏ -webkit-box */
        line-height: 1.4em; /* Chiều cao 1 dòng */
        max-height: 2.8em; /* Giới hạn đúng 2 dòng (1.4 * 2) */
        overflow: hidden; /* Ẩn phần dư nếu JS cắt chưa chuẩn */
        word-wrap: break-word;
    }
    
    /* --- FEATURE: Message Time --- */
    .msg-time {
        font-size: 0.65rem;
        margin-top: 4px;
        text-align: right;
        opacity: 0.7;
        font-weight: 500;
    }
    .msg-row.me .msg-time {
        color: rgba(255, 255, 255, 0.9);
    }
    .msg-row:not(.me) .msg-time {
        color: var(--text-sub);
    }

    /* --- FEATURE MỚI: Highlight tìm kiếm --- */
    .highlight-text {
        background-color: #fde047; /* Vàng */
        color: #000;
        font-weight: bold;
        border-radius: 2px;
        padding: 0 2px;
    }

    /* --- Nút Reply Action --- */
    .msg-actions { 
        opacity: 0; 
        transition: opacity 0.2s; 
        display: flex; 
        align-items: center; 
        padding: 0 5px; 
    }
    .msg-row:hover .msg-actions { opacity: 1; }
    
    .btn-reply-action { 
        width: 30px; 
        height: 30px; 
        border-radius: 50%; 
        background: #f3f4f6; 
        border: none; 
        color: var(--text-sub); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        transition: 0.2s; 
    }
    .btn-reply-action:hover { 
        background: #e5e7eb; 
        color: var(--primary); 
    }

    /* --- Reply Context Bar (Thanh hiển thị đang trả lời) --- */
    #reply-context-bar { 
        display: none; 
        align-items: center; 
        justify-content: space-between; 
        padding: 8px 20px; 
        background-color: #fff; 
        border-top: 1px solid var(--border-color); 
        border-left: 4px solid var(--primary); 
        animation: slideUp 0.3s ease; 
    }
    #reply-context-bar.show { display: flex; }
    .reply-to-label { font-weight: 700; color: var(--primary); font-size: 0.8rem; }
    .reply-preview-text { 
        color: var(--text-sub); 
        font-size: 0.85rem; 
        max-width: 300px; 
        /* Cắt ngắn ở thanh input */
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
    }

    @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Footer Input */
    .chat-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
        background: white;
        display: flex; 
        flex-direction: column; /* Đổi thành column để chứa preview box */
        gap: 10px;
    }

    .footer-tools {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        width: 100%;
    }

    /* --- Preview Box --- */
    #preview-box { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 0px; }
    .preview-img-wrap { position: relative; width: 60px; height: 60px; flex-shrink: 0; }
    .preview-img-wrap img { width: 100%; height: 100%; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color); }
    .btn-remove-preview { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; }

    .input-wrapper {
        flex: 1; 
        background: var(--bg-sidebar);
        border-radius: 20px;
        padding: 10px 16px; 
        display: flex; 
        align-items: center;
        gap: 10px;
        border: 1px solid transparent;
        transition: all 0.2s;
    }
    
    .input-wrapper:focus-within { 
        background: white;
        border-color: var(--primary);
    }
    
    .chat-input {
        width: 100%; 
        border: none; 
        background: transparent;
        outline: none; 
        resize: none; 
        max-height: 100px;
        font-family: inherit; 
        font-size: 0.95rem;
        color: var(--text-main);
    }
    
    .chat-input::placeholder {
        color: var(--text-sub);
    }

    .btn-action {
        width: 40px; 
        height: 40px; 
        border-radius: 50%;
        display: flex; 
        align-items: center; 
        justify-content: center;
        border: none; 
        background: white;
        color: var(--primary);
        font-size: 1.1rem; 
        cursor: pointer; 
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .btn-action:hover { 
        background: var(--bg-hover);
    }
    
    .btn-send { 
        background: var(--primary);
        color: white;
    }
    
    .btn-send:hover { 
        background: var(--primary-hover);
    }

    /* ==================================================
       3. CỘT PHẢI - THÔNG TIN
       ================================================== */
    .right-sidebar {
        width: var(--sb-right-w);
        background: white;
        border-left: 1px solid var(--border-color);
        display: flex; 
        flex-direction: column;
        transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
    }

    .right-sidebar.collapsed {
        margin-right: calc(var(--sb-right-w) * -1);
    }

    .rs-content { 
        flex: 1; 
        overflow-y: auto;
        background: white;
    }
    
    .rs-content::-webkit-scrollbar { width: 6px; }
    .rs-content::-webkit-scrollbar-track { background: transparent; }
    .rs-content::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    
    .rs-section { 
        padding: 16px; 
        border-bottom: 1px solid var(--border-color);
    }
    
    .rs-header { 
        text-align: center; 
        padding: 24px 20px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .rs-header img { 
        width: 80px; 
        height: 80px; 
        border-radius: 50%; 
        object-fit: cover; 
        margin-bottom: 12px;
    }
    
    .rs-header h5 {
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
        font-size: 1rem;
    }
    
    .rs-header a {
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .rs-btn {
        width: 100%; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        background: none; 
        border: none; 
        padding: 10px 4px;
        font-weight: 600;
        color: var(--text-main);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 6px;
    }
    
    .rs-btn:hover { 
        color: var(--primary);
        background: var(--bg-hover);
    }

    /* Search Box */
    .search-box {
        background: var(--bg-sidebar);
        border-radius: 8px;
        padding: 8px 12px;
        display: none;
        align-items: center;
        margin-top: 10px;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }
    
    .search-box.active { 
        display: flex;
    }
    
    .search-box:focus-within {
        border-color: var(--primary);
    }
    
    .search-box input { 
        border: none;
        background: transparent;
        width: 100%;
        outline: none;
        font-size: 0.9rem;
        color: var(--text-main);
    }

    /* Member List */
    .member-row { 
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 4px;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .member-row:hover {
        background: var(--bg-hover);
    }
    
    .member-row img { 
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .member-row .fw-bold {
        color: var(--text-main);
        font-size: 0.9rem;
    }

    /* Media Grid */
    .media-grid { 
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        padding: 10px 0;
    }
    
    .media-item { 
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }
    
    .media-item:hover {
        border-color: var(--primary);
    }
    
    .media-item img { 
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s;
    }
    
    .media-item:hover img { 
        transform: scale(1.05);
    }

    /* Responsive */
    @media (max-width: 992px) {
        .left-sidebar { 
            position: absolute;
            height: 100%;
            box-shadow: 5px 0 20px rgba(0,0,0,0.15);
            margin-left: calc(var(--sb-left-w) * -1);
        }
        .left-sidebar.show { 
            margin-left: 0;
        }
        
        .right-sidebar { 
            position: absolute;
            right: 0;
            height: 100%;
            box-shadow: -5px 0 20px rgba(0,0,0,0.15);
            margin-right: calc(var(--sb-right-w) * -1);
        }
        .right-sidebar.show { 
            margin-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-layout">
    
    <!-- 1. CỘT TRÁI: DANH SÁCH NHÓM -->
    <aside class="left-sidebar" id="left-sidebar">
        <div class="ls-header">
            <i class="fas fa-comments"></i>
            <span>Nhóm của bạn</span>
        </div>
        <div class="group-list">
            {% for my_trip in my_trips %}
            <a href="{{ my_trip.get_chat_url }}" class="group-item {% if my_trip.pk == trip.pk %}active{% endif %}">
                <img src="{{ my_trip.cover_url }}" class="group-avatar">
                <div class="group-info">
                    <div class="group-name">{{ my_trip.ten_chuyen_di }}</div>
                    <div class="group-status">
                        {% if my_trip.pk == trip.pk %}
                            <span class="text-primary">● Đang xem</span>
                        {% else %}
                            {{ my_trip.nguoi_to_chuc.last_name }}: {{ my_trip.trang_thai.ten }}
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- 2. CỘT GIỮA: CHAT -->
    <main class="chat-center">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <button class="toggle-sidebar-btn" onclick="toggleLeftSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="header-info">
                    <img src="{{ trip.cover_url }}">
                    <div class="header-text">
                        <div class="header-title">{{ trip.ten_chuyen_di }}</div>
                        <div class="header-status">
                            <i class="fas fa-circle" style="font-size: 8px;"></i> 
                            Đang hoạt động
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="toggle-sidebar-btn" onclick="toggleRightSidebar()" title="Thông tin hội thoại">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-box">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;"></div>
                <p class="text-muted small fw-bold">Đang tải tin nhắn...</p>
            </div>
        </div>

        <!-- FEATURE BỔ SUNG: Thanh Reply Context -->
        <div id="reply-context-bar">
            <div class="reply-info">
                <span class="reply-to-label">
                    <i class="fas fa-reply me-1"></i>Đang trả lời <span id="reply-to-user">...</span>
                </span>
                <span class="reply-preview-text" id="reply-to-content">...</span>
            </div>
            <button type="button" class="btn-close ms-3 small" onclick="cancelReply()"></button>
        </div>

        <!-- Footer -->
        <form id="chat-form" class="chat-footer" method="POST" action="javascript:void(0);">
            {% csrf_token %}
            <!-- FEATURE BỔ SUNG: Hidden Input cho Reply và Preview Box -->
            <input type="hidden" id="reply-id-input" name="reply_to_id" value="">
            <div id="preview-box"></div>

            <div class="footer-tools">
                <label for="file-input" class="btn-action" title="Gửi ảnh/video">
                    <i class="fas fa-image"></i>
                </label>
                <input type="file" id="file-input" name="files" multiple hidden accept="image/*,video/*">
                
                <div class="input-wrapper">
                    <textarea id="msg-input" name="message" class="chat-input" rows="1" placeholder="Nhập tin nhắn..."></textarea>
                    <i class="fas fa-smile text-muted cursor-pointer" style="font-size: 1.3rem;"></i>
                </div>
                
                <button type="submit" class="btn-action btn-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </main>

    <!-- 3. CỘT PHẢI: THÔNG TIN -->
    <aside class="right-sidebar" id="right-sidebar">
        <div class="rs-content">
            <div class="rs-header">
                <img src="{{ trip.cover_url }}">
                <h5>{{ trip.ten_chuyen_di }}</h5>
                <a href="{{ trip.get_absolute_url }}" class="text-decoration-none text-primary">
                    <i class="fas fa-external-link-alt me-1"></i>Xem chi tiết chuyến đi
                </a>
            </div>

            <!-- Tìm kiếm -->
            <div class="rs-section">
                <button class="rs-btn" onclick="toggleSearch()">
                    <span><i class="fas fa-search me-2"></i>Tìm kiếm tin nhắn</span>
                    <i class="fas fa-chevron-right text-muted"></i>
                </button>
                <div class="search-box" id="search-container">
                    <i class="fas fa-search text-muted me-2"></i>
                    <input type="text" id="chat-search" placeholder="Nhập từ khóa...">
                </div>
            </div>

            <!-- Thành viên -->
            <div class="rs-section">
                <button class="rs-btn" data-bs-toggle="collapse" data-bs-target="#collapseMembers">
                    <span><i class="fas fa-users me-2"></i>Thành viên ({{ members.count }})</span>
                    <i class="fas fa-chevron-down text-muted"></i>
                </button>
                <div class="collapse show" id="collapseMembers">
                    <div class="mt-2" style="max-height: 220px; overflow-y: auto;">
                        <div class="member-row">
                            <img src="{{ trip.nguoi_to_chuc.taikhoanhoso.avatar_url|default:'/static/images/default-avatar.png' }}">
                            <div>
                                <div class="fw-bold">{{ trip.nguoi_to_chuc.get_full_name|default:trip.nguoi_to_chuc.username }}</div>
                                <small class="text-warning fw-bold" style="font-size: 0.7rem;">
                                    <i class="fas fa-crown me-1"></i>Trưởng đoàn
                                </small>
                            </div>
                        </div>
                        {% for member in members %}
                            {% if member.user != trip.nguoi_to_chuc %}
                            <div class="member-row">
                                <img src="{{ member.user.taikhoanhoso.avatar_url|default:'/static/images/default-avatar.png' }}">
                                <div class="fw-bold">{{ member.user.get_full_name|default:member.user.username }}</div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- File phương tiện -->
            <div class="rs-section">
                <button class="rs-btn" data-bs-toggle="collapse" data-bs-target="#collapseMedia">
                    <span><i class="fas fa-images me-2"></i>Kho Ảnh & Video</span>
                    <i class="fas fa-chevron-down text-muted"></i>
                </button>
                <div class="collapse show" id="collapseMedia">
                    <div id="light-gallery-sidebar" class="media-grid">
                        {% regroup chat_media_files by tin_nhan.nguoi_gui as sender_list %}
                        {% for sender in sender_list %}
                            {% for media in sender.list %}
                                {% if media.loai_media == 'ANH' %}
                                <a href="{{ media.duong_dan_file.url }}" class="media-item" data-sub-html="Gửi bởi {{ sender.grouper.username }}">
                                    <img src="{{ media.duong_dan_file.url }}">
                                </a>
                                {% endif %}
                            {% endfor %}
                        {% empty %}
                            <p class="text-muted small text-center w-100 py-3">Chưa có ảnh nào.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.0/lightgallery.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.0/plugins/zoom/lg-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.0/plugins/thumbnail/lg-thumbnail.min.js"></script>
<script>
    // === UI LOGIC: TOGGLE SIDEBARS ===
    function toggleLeftSidebar() {
        const sb = document.getElementById('left-sidebar');
        if (window.innerWidth <= 992) {
            sb.classList.toggle('show');
        } else {
            sb.classList.toggle('collapsed');
        }
    }

    function toggleRightSidebar() {
        const sb = document.getElementById('right-sidebar');
        if (window.innerWidth <= 992) {
            sb.classList.toggle('show');
        } else {
            sb.classList.toggle('collapsed');
        }
    }

    function toggleSearch() {
        document.getElementById('search-container').classList.toggle('active');
        document.getElementById('chat-search').focus();
    }

    // === SEARCH & HIGHLIGHT LOGIC ===
    function highlightSearchTerm(element, term) {
        if (!term) return;
        
        // Dùng TreeWalker để duyệt qua các node văn bản an toàn, tránh làm hỏng HTML tags
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
        const textNodes = [];
        let node;
        while(node = walker.nextNode()) {
            textNodes.push(node);
        }

        textNodes.forEach(textNode => {
            const text = textNode.nodeValue;
            const lowerText = text.toLowerCase();
            const index = lowerText.indexOf(term);
            
            if (index !== -1) {
                const parent = textNode.parentNode;
                // Bỏ qua nếu đã highlight rồi hoặc nằm trong thẻ script/style
                if (parent.classList.contains('highlight-text') || ['SCRIPT', 'STYLE'].includes(parent.tagName)) return;

                // Tách node văn bản và chèn thẻ span highlight
                const range = document.createRange();
                range.setStart(textNode, index);
                range.setEnd(textNode, index + term.length);
                
                const highlightSpan = document.createElement('span');
                highlightSpan.className = 'highlight-text';
                
                try {
                    range.surroundContents(highlightSpan);
                } catch(e) {
                    // Bỏ qua lỗi phức tạp nếu cấu trúc DOM quá rối
                }
            }
        });
    }

    function resetHighlight(element) {
        // Tìm tất cả các span highlight và trả lại nội dung gốc
        const highlights = element.querySelectorAll('.highlight-text');
        highlights.forEach(span => {
            const parent = span.parentNode;
            parent.replaceChild(document.createTextNode(span.textContent), span);
            parent.normalize(); // Gộp các text node liền kề lại
        });
    }

    document.getElementById('chat-search').addEventListener('keyup', function() {
        const term = this.value.toLowerCase();
        const msgRows = document.querySelectorAll('.msg-row');

        msgRows.forEach(row => {
            const bubble = row.querySelector('.msg-bubble');
            if (!bubble) return;

            // 1. Reset highlight cũ
            resetHighlight(bubble);

            // 2. Kiểm tra và filter
            const textContent = bubble.textContent.toLowerCase();
            if (term && !textContent.includes(term)) {
                row.style.display = 'none';
            } else {
                row.style.display = 'flex';
                // 3. Highlight mới nếu có từ khóa
                if (term) {
                    highlightSearchTerm(bubble, term);
                }
            }
        });
    });

    // === FEATURE BỔ SUNG: Functions cho Reply & Date ===
    let lastRenderedDate = null;

    function formatDateDivider(isoDateString) {
        const date = new Date(isoDateString);
        const now = new Date();
        const days = ['Chủ Nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
        const isCurrentYear = date.getFullYear() === now.getFullYear();
        const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth()+1).toString().padStart(2, '0')}`;
        const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        return isCurrentYear ? `${days[date.getDay()]}, ${dateStr} lúc ${timeStr}` : `${days[date.getDay()]}, ${dateStr}/${date.getFullYear()} lúc ${timeStr}`;
    }

    function checkAndAddDateDivider(msgDateIso) {
        const msgDate = new Date(msgDateIso);
        const dateKey = msgDate.toDateString(); 
        if (lastRenderedDate !== dateKey) {
            const dividerText = formatDateDivider(msgDateIso);
            const html = `<div class="date-divider"><span>${dividerText}</span></div>`;
            document.getElementById('chat-box').insertAdjacentHTML('beforeend', html);
            lastRenderedDate = dateKey;
        }
    }

    // Helper JS truncate string
    function truncateString(str, num) {
        if (!str) return '';
        if (str.length <= num) {
            return str;
        }
        return str.slice(0, num) + '...';
    }

    function startReply(id, username, content) {
        document.getElementById('reply-id-input').value = id;
        document.getElementById('reply-to-user').innerText = username;
        // Cắt ngắn trong input reply preview luôn cho gọn
        document.getElementById('reply-to-content').innerText = truncateString(content || "[File phương tiện]", 60);
        document.getElementById('reply-context-bar').classList.add('show');
        document.getElementById('msg-input').focus();
    }

    window.cancelReply = function() {
        document.getElementById('reply-id-input').value = '';
        document.getElementById('reply-context-bar').classList.remove('show');
    }

    window.clearFiles = function() {
        document.getElementById('file-input').value = '';
        document.getElementById('preview-box').innerHTML = '';
    }

    // === CHAT LOGIC ===
    document.addEventListener('DOMContentLoaded', function() {
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-input');
        const fileInput = document.getElementById('file-input');
        const previewBox = document.getElementById('preview-box');
        
        const urlSend = "{% url 'trips:chat_send' trip.pk %}";
        const urlGet = "{% url 'trips:chat_get_messages' trip.pk %}";
        let lastMsgId = 0;
        let isSending = false;

        // Init LightGallery for sidebar
        try {
            const lg = document.getElementById('light-gallery-sidebar');
            if(lg) lightGallery(lg, { selector: 'a', speed: 300, download: false, plugins: [lgZoom, lgThumbnail] });
        } catch(e){}

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendMessage(msg) {
            // Logic thêm ngày tháng
            if (msg.full_date) checkAndAddDateDivider(msg.full_date);

            const isMe = msg.is_me;
            
            // Logic xử lý media
            let mediaHtml = '';
            if(msg.media && msg.media.length > 0) {
                mediaHtml = `<div class="d-flex flex-wrap gap-2 mt-2" id="gal-${msg.id}">`;
                msg.media.forEach(m => {
                    if(m.type === 'ANH') {
                        mediaHtml += `<a href="${m.url}" class="msg-thumb-link"><img src="${m.url}" style="max-height: 160px; border-radius: 12px; cursor: pointer; border: 2px solid rgba(255,255,255,0.3);"></a>`;
                    }
                });
                mediaHtml += '</div>';
            }

            // Logic xử lý Reply (Trích dẫn tin nhắn cũ)
            // UPDATE: Dùng JS truncate kết hợp CSS max-height
            let replyHtml = '';
            if (msg.reply) {
                // Giới hạn khoảng 80-100 ký tự để giả lập 2 dòng
                const truncatedContent = truncateString(msg.reply.content, 90);
                
                replyHtml = `
                    <div class="msg-reply-bubble" onclick="document.getElementById('msg-${msg.reply.id}')?.scrollIntoView({behavior: 'smooth', block: 'center'})">
                        <div class="fw-bold mb-1" style="color: ${isMe ? '#e6f4ea' : 'var(--primary)'}">${msg.reply.username}</div>
                        <div class="reply-content-truncate" title="${msg.reply.content}">${truncatedContent}</div>
                    </div>
                `;
            }

            // Logic xử lý Reply Action Button (Nút trả lời)
            // Lọc dấu nháy để tránh lỗi JS
            const safeContent = (msg.content || "").replace(/'/g, "\\'").replace(/"/g, '&quot;'); 
            const actionBtn = `
                <div class="msg-actions">
                    <button class="btn-reply-action" onclick="startReply(${msg.id}, '${msg.username}', '${safeContent}')" title="Trả lời">
                        <i class="fas fa-reply"></i>
                    </button>
                </div>
            `;

            // Logic thêm giờ nhắn tin vào bubble
            let timeStr = "";
            if(msg.full_date) {
                const dateObj = new Date(msg.full_date);
                timeStr = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
            }

            // Sắp xếp thứ tự hiển thị nút Reply và Bubble dựa vào isMe
            // isMe: [Action Btn] [Content]
            // Not Me: [Avatar] [Content] [Action Btn]
            const contentHtml = `
                <div class="msg-content">
                    ${!isMe ? `<div class="msg-name">${msg.username}</div>` : ''}
                    <div class="msg-bubble">
                        ${replyHtml}
                        ${msg.content ? `<div>${msg.content}</div>` : ''}
                        ${mediaHtml}
                        <div class="msg-time">${timeStr}</div>
                    </div>
                </div>
            `;

            const html = `
                <div class="msg-row ${isMe ? 'me' : ''}" id="msg-${msg.id}">
                    ${!isMe ? `<img src="${msg.avatar}" class="msg-avatar" title="${msg.username}">` : ''}
                    
                    ${isMe ? actionBtn : ''}
                    ${contentHtml}
                    ${!isMe ? actionBtn : ''}
                </div>
            `;
            chatBox.insertAdjacentHTML('beforeend', html);

            // Init gallery cho tin nhắn mới
            if(msg.media && msg.media.length > 0) {
                const newGal = document.getElementById(`gal-${msg.id}`);
                lightGallery(newGal, { selector: '.msg-thumb-link', plugins: [lgZoom, lgThumbnail], speed: 300, download: false });
            }
        }

        function loadMessages() {
            // Prevent fetch error in static preview where Django tags aren't rendered
            if (urlGet.indexOf('{%') !== -1) return;

            fetch(`${urlGet}?last_id=${lastMsgId}`)
                .then(res => res.json())
                .then(data => {
                    const spinner = document.querySelector('.loading-spinner');
                    if(spinner) spinner.remove();

                    if(data.messages && data.messages.length > 0) {
                        let shouldScroll = (chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 150) || lastMsgId === 0;
                        
                        data.messages.forEach(msg => {
                            if(!document.getElementById(`msg-${msg.id}`)) {
                                appendMessage(msg);
                                lastMsgId = msg.id;
                            }
                        });
                        
                        if(shouldScroll) scrollToBottom();
                    }
                })
                .catch(err => console.error(err));
        }

        loadMessages();
        setInterval(loadMessages, 3000);

        // Preview ảnh khi chọn file
        fileInput.addEventListener('change', function() {
            previewBox.innerHTML = '';
            if(this.files.length > 0) {
                Array.from(this.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewBox.innerHTML += `<div class="preview-img-wrap"><img src="${e.target.result}"><div class="btn-remove-preview" onclick="clearFiles()">×</div></div>`;
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if(isSending) return;

            const text = msgInput.value.trim();
            const files = fileInput.files;

            if(!text && files.length === 0) return;

            // Prevent fetch error in static preview
            if (urlSend.indexOf('{%') !== -1) {
                console.log("Submit ignored in preview mode (Django tags not rendered).");
                return;
            }

            const formData = new FormData(chatForm); // Sử dụng FormData(form) để lấy cả input hidden reply_to_id

            isSending = true;
            const btn = chatForm.querySelector('.btn-send');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch(urlSend, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    msgInput.value = '';
                    // Reset file và preview
                    clearFiles(); 
                    // Reset reply
                    cancelReply();
                    
                    msgInput.style.height = 'auto';
                    loadMessages();
                } else {
                    alert(data.message);
                }
            })
            .catch(err => alert("Lỗi kết nối!"))
            .finally(() => {
                isSending = false;
                btn.innerHTML = originalHTML;
                msgInput.focus();
            });
        });

        msgInput.addEventListener('keydown', function(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
        
        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    });
</script>
{% endblock %}